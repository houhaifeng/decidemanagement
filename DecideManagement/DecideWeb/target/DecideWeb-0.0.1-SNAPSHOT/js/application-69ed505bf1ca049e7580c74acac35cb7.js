(function(){window.console||(window.console={});var names=["log","debug","info","warn","error","assert","dir","dirxml","group","groupEnd","time","timeEnd","count","trace","profile","profileEnd"],i=names.length,noop=function(){};while(i--){window.console[names[i]]=noop}})();window.ns=function(namespace,obj){var buildNamespace=function(fullNameSpace,delimiter){var nameSpacedObject=window,names=fullNameSpace.split(delimiter||"."),nameCount=names.length;for(var i=0;i<nameCount;i++){var name=names[i],nameObject=nameSpacedObject[name];if(nameObject===undefined){nameObject={};nameSpacedObject[name]=nameObject}nameSpacedObject=nameObject}return nameSpacedObject};var ns=buildNamespace(namespace);return obj?_.extend(ns,obj):ns};ns("py").register=ns;py.register("decide.message");window.fmt={};decide.message.formatter=new function(){this.format=function(key,defaultText,argumentsArray){defaultText=defaultText||"";argumentsArray=argumentsArray||[];for(var i=0;i<argumentsArray.length;i++){var arg=argumentsArray[i];if(!(arg instanceof String)){argumentsArray[i]=arg.toString()}}var formatted=fmt[key];if(formatted){return formatted.format(argumentsArray)}return(defaultText)?defaultText:""};this.formatPlural=function(key,defaultText,number){var compare=parseFloat(number,10);if(compare>1){key+=".plural"}else{if(compare<1){key+=".lessThan"}}return decide.message.formatter.format(key,defaultText,[number])};this.formatPluralWithArgs=function(key,defaultText,number,args){var compare=parseFloat(number,10);if(compare>1){key+=".plural"}else{if(compare<1){key+=".lessThan"}}return decide.message.formatter.format(key,defaultText,args)};this.formatArray=function(unformatted,argArray){var formatted=unformatted;for(var i=0;i<argArray.length;i++){formatted=decide.message.formatter.formatArg(formatted,argArray[i],i)}return formatted};this.formatArg=function(unformatted,val,ndx){return unformatted.replace("{"+ndx+"}",val)}};String.prototype.format=function(){var formatted=this;if(arguments[0]!=undefined){for(var i=0;i<arguments.length;i++){var argument=arguments[i];if(argument==undefined){break}if(argument instanceof Array&&i===0){return decide.message.formatter.formatArray(formatted,argument)}else{decide.message.formatter.formatArg(formatted,argument,i)}}}return formatted};ns("decide").routes={home:"/",about:"/about",howItWorks:"/how-it-works",deals:"/deals",product:function(pid){return"/p/"+pid}};ns("decide").media=(function(){var _getMediaType=function(){var element=$("span#media_type_container")[0];if($("html").is(".ie")){return element.currentStyle["font-family"]||element.currentStyle.fontFamily}else{return window.getComputedStyle(element,"").getPropertyValue("content")}};var my={};my.mediaType=_getMediaType;my.isMediaType=function(mediaType){var currentMediaType=_getMediaType();return typeof(currentMediaType)==="string"&&(currentMediaType.indexOf(mediaType)!==-1)};return my}());(function(){var nativeEncodeURIComponent=encodeURIComponent;window.encodeURIComponent=function fixedEncodeURIComponent(str){return nativeEncodeURIComponent(str).replace(/!/g,"%21").replace(/'/g,"%27").replace(/\(/g,"%28").replace(/\)/g,"%29").replace(/\*/g,"%2A")}})(this);if(!String.prototype.supplant){String.prototype.supplant=function(o){return this.replace(/{([^{}]*)}/g,function(a,b){var r=o[b];return typeof r==="string"||typeof r==="number"?r:a})}}$.ajaxSetup({cache:false});function nestedField(context,chain){chain=chain.split(".");if(context===undefined){return context}var obj=context[chain.shift()];while(obj&&chain.length){obj=obj[chain.shift()]}return obj}$(function(){if(typeof(_)!="undefined"){_.templateSettings={interpolate:/\{\{(.+?)\}\}/g}}});$.extend({getUrlVars:function(){var vars=[],hash;var hashes=window.location.href.slice(window.location.href.indexOf("?")+1).split("&");for(var i=0;i<hashes.length;i++){hash=hashes[i].split("=");vars.push(hash[0]);vars[hash[0]]=hash[1]}return vars},getUrlVar:function(name){return $.getUrlVars()[name]}});function encodeSearchQuery(query){return encodeURIComponent(query)}$(function(){function isSearchPage(){return $("body").is(".search_page")}var format=decide.message.formatter.format,formatPlural=decide.message.formatter.formatPlural;decide.util.facebook.load();$(".click_expander .abbrev").live("click",function(e){$(this).siblings(".expanded").toggle();return false});var $window=$(window),$header=$("#header_wrapper, header#home");$("#browse_products_link").click(function(){$("#browse_products_link").toggleClass("active");$("#browse_products_dropdown").toggle()});$(document).click(function(){$("#browse_products_link").removeClass("active");$("#browse_products_dropdown").hide()});$("#browse_products_link").click(function(){return false});$("body .horizontal.popular a").click(function(event){var value=$(this).text();setLastSearch(value);return true});$(".query_input").blur(function(){if(this.value===""){this.value=this.defaultValue}});var $search=$(".query_input");function setLastSearch(search){var expires=new Date();expires.setSeconds(expires.getSeconds()+60);$.cookie("lastSearch",search,{path:"/",expires:expires})}$(".model_feedback a").live("click",function(e){var url=$(e.target).attr("href");url+="&entry_0="+encodeURIComponent(window.location.href);window.open(url,"_blank");return false});$(".disabled").live("click",function(){return false});$(".cat_nav a.category").live("click",function(e){var href=$(e.currentTarget).attr("href");if(isSearchPage()){href=href.replace(/^\/search\//,"");Backbone.history.navigate(href,{trigger:true});return false}});_($("ol.rounded_numbers")).each(function(ol){_($(ol).find("li")).each(function(li,i){$(li).attr("data-index",i+1)})});$(".ie9 .icon-large").css("font-size","0.75em");$(".ie8 .icon-large").removeClass("icon-large");$(".ie8 body:not(.home_page) .search_form .search_button").css({position:"relative",top:"-3px"})});$(function(){console.log("keyboard");var $body=$("body");$body.keyup(function(e){if(!$("#ki_container").length||$("#ki_container").hasClass("ki_minimized")){if($("input:focus").length>0){handleKeyInSearchbox(e)}else{if($body.is(".product_page")){handleProductPage(e)}}handleGlobalShortcuts(e)}});function handleKeyInSearchbox(e){switch(e.keyCode){case 27:$(".query_input:visible").blur();break}}function handleGlobalShortcuts(e){switch(e.keyCode){case 191:$(".query_input:visible").focus();break}}function handleProductPage(e){switch(e.keyCode){case 85:if(history.length<=1){window.close()}else{history.back()}break}}});ns("decide").confidenceOverlay={delayMs:200,hideTimeout:null,showTimeout:null,handleHover:function(scope){$(".confidence_details",scope).hover(this.hoverIn,this.hoverOut);$(".confidence_details",scope).click(this.hoverIn)},hoverIn:function(now){var $this=$(this);clearTimeout(decide.confidenceOverlay.hideTimeout);decide.confidenceOverlay.showTimeout=setTimeout(function(){$this.parent().find(".overlay").fadeIn("fast")},decide.confidenceOverlay.delayMs)},hoverOut:function(){var $this=$(this);clearTimeout(decide.confidenceOverlay.showTimeout);decide.confidenceOverlay.hideTimeout=setTimeout(function(){$this.parent().find(".overlay").fadeOut("fast")},decide.confidenceOverlay.delayMs)},hoverEverythingOut:function(){$(".overlay").fadeOut("fast")}};$(function(){decide.confidenceOverlay.handleHover(document)});$(document).bind("touchstart",function(){decide.confidenceOverlay.hoverEverythingOut()});ns("decide.core").renderContext=(function(){var format=decide.message.formatter.format;var instance;var init=function(){var esc=py.helpers.escapeHTML;var context={format:function(){return function(text,render){return esc(format(render(text)))}},formatHtml:function(){return function(text,render){return format(render(text))}},formatCurrency:function(){return function(text,render){return new DecimalFormat(format("number.priceCents")).format(render(text))}},formatShortDateTime:function(){return function(text,render){return new Date(parseInt(render(text),10)).forPattern(format("dateTime.short"))}},formatShortDate:function(){return function(text,render){var unparsed=render(text);var date=new Date(unparsed);if(_.isNaN(date.getTime())){if(unparsed.indexOf(",")!=-1){var parts=unparsed.split(",");if(parts.length>=3){date=new Date(parts[0],parts[1]-1,parts[2])}}else{console.error("Unable to parse date",unparsed);return""}}return date.forPattern(format("date.short"))}},applicationVersion:decide.applicationVersion,getOrElse:function(){return function(text,render){var r=render(text);var parts=r.split("{||}");if(parts.length<2){throw"getOrElse requires 2 conditions but got: "+r}else{var firstChoice=_.first(parts);var defaultText=_.rest(parts).join("{||}");return(_.isEmpty(firstChoice.trim()))?defaultText:firstChoice}}}};if(ns("decide.features")){_.each(ns("decide.features"),function(isEnabled,feature){context["feature/"+feature]=isEnabled})}if(ns("decide.membershipFeatures")){_.each(ns("decide.membershipFeatures"),function(isEnabled,feature){context["membershipFeature/"+feature]=isEnabled})}if(decide.user&&decide.user.get("emailAddress")){context["account/loggedIn"]=true}if(context["membershipFeature/paid"]){context["access/full"]=true}return context};return{get:function(){return instance||(instance=init())},refresh:function(){instance=init()}}}());ns("decide").Context=function(options){options=options||{};if(options.hasOwnProperty("model")){this.model=options.model}this.configure.apply(this,arguments);this.initialize.apply(this,arguments)};_.extend(decide.Context.prototype,{configure:function(){this.format=decide.message.formatter.format;this.formatPlural=decide.message.formatter.formatPlural;this.currencyFormatterRounded=new DecimalFormat(decide.message.formatter.format("number.priceNoCents"));this.dateTimeShort=this.format("dateTime.short")},initialize:function(){},supportsContext:function(name){return _.isFunction(this.getViewContext(name))},getViewContext:function(name){return this[name+"Context"]}});ns("decide").Context.extend=Backbone.View.extend;$(function(){if(typeof(Zenbox)!=="undefined"){Zenbox.init({dropboxID:"20099732",url:"https://decide.zendesk.com",tabID:"Feedback",tabColor:"#444",tabPosition:"Bottom"});$("#zenbox_tab").css({left:"",filter:"",display:""});$("a.zenbox_activate").click(function(){Zenbox.show();return false})}});ns("decide").env={isPhoneGap:function(){return typeof(PhoneGap)!=="undefined"},isIOSDevice:function(){return navigator.platform.indexOf("iPhone")>=0||navigator.platform.indexOf("iPad")>=0||navigator.platform.indexOf("iPod")>=0},getIOSVersion:function(){var version;var match=navigator.userAgent.match(/OS (\d_\d+(_\d+)*) like Mac OS X/);if(match&&match.length>1){version=match[1].replace("_",",");version=parseFloat(version);if(_.isNaN(version)){version=0}}return version},isAndroidDevice:function(){return navigator.userAgent.indexOf("Android")>=0},getAndroidVersion:function(){var version;var match=navigator.userAgent.match(/Android\s+([\d\.]+)/);if(match&&match.length>1){version=match[1]}return version},isMobile:function(){return($(window).width()<=480)},isTablet:function(){return($(window).width()<=767)},isSafari:function(){var ua=navigator.userAgent;return(ua.indexOf("Safari")!==-1&&ua.indexOf("Chrome")===-1&&!decide.env.isAndroidDevice())},fullpath:function(){return document.location.pathname+document.location.search},hasPushState:function(){var has=!!(window.history&&window.history.pushState);return has&&!decide.env.isAndroidDevice()},isFullsite:function(){return !(decide.env.isIOSDevice()||decide.env.isAndroidDevice()||decide.env.isTablet())},endpoint:function(path){var prod=py.ENDPOINT||"https://www.decide.com";return decide.env.isPhoneGap()?prod+path:path},runOrWaitForPhoneGap:function(fn){if(decide.env.isPhoneGap()&&!PhoneGap.available){document.addEventListener("deviceready",fn,false)}else{fn()}},hasLocation:function(){return py&&py.geoloc&&py.geoloc.loaded&&py.geoloc.position},isPositionFixedSupported:function(){return this._positionFixedSupported||false},detectFixedPosition:function(){var isSupported=true;if(navigator.userAgent.match(/iPad|iPhone/i)!==null){isSupported=navigator.userAgent.match(/[5-9]_[0-9]/)!==null;this._positionFixedSupported=isSupported;return}var container=document.body;if(document.createElement&&container&&container.appendChild&&container.removeChild){var el=document.createElement("div");if(!el.getBoundingClientRect){return}var topOffset=100;el.innerHTML="x";el.style.cssText="position:fixed;top:"+topOffset+"px;";container.appendChild(el);var originalHeight=container.style.height,originalScrollTop=container.scrollTop,scrollBy=500;container.style.height="3000px";window.scrollTo(0,scrollBy);var elementTop=Math.round(el.getBoundingClientRect().top);container.style.height=originalHeight;isSupported=(elementTop===topOffset);container.removeChild(el);window.scrollTo(0,originalScrollTop)}this._positionFixedSupported=isSupported}};decide.env.detectFixedPosition();
/*!
 * Based on DateTimeFormat from the Joda library (joda-time-1.5.2) licensed under the Apache License, Version 2.0
 * http://joda-time.sourceforge.net/
 */
py.register("py.date");py.date.jodaFormat=function(jodaPattern,value,UCampm,locale,useUTC){var _days={en_US:["Sunday","Monday","Tuesday","Wednesday","Thursday","Friday","Saturday"]};var _daysAbbr={en_US:["Sun","Mon","Tue","Wed","Thu","Fri","Sat"]};var _months={en_US:["January","February","March","April","May","June","July","August","September","October","November","December"]};var _monthsAbbr={en_US:["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"]};var _apmpm={en_US:{AM:"am",PM:"pm"}};var _ampmAbbr={en_US:{AM:"a",PM:"p"}};var _locale="en_US";var _useUTC=useUTC?useUTC:false;var date=null;try{date=py.date.parse(value)}catch(e){throw ("Could not parse date from "+value)}if(jodaPattern&&date!=null){var length=jodaPattern.length;var currentIndex=[];var formattedDateString=[];for(var i=0;i<length;i++){currentIndex[0]=i;var token=_parseToken(jodaPattern,currentIndex);i=currentIndex[0];var tokenLen=token.length;if(tokenLen==0){break}var c=token.charAt(0);switch(c){case"G":throw ("Unsupported string formatting token: "+c);break;case"C":var y=String(_formatYear(date,_useUTC));formattedDateString.push(y.substring(0,2));break;case"x":throw ("Unsupported string formatting token: "+c);break;case"y":formattedDateString.push(_formatYear(date,_useUTC));break;case"Y":if(tokenLen==2){var y=String(_formatYear(date,_useUTC));formattedDateString.push(y.substring(y.length-2,y.length))}else{var y=_formatYear(date,_useUTC);for(var j=(String(y)).length;j<tokenLen;j++){formattedDateString.push("0")}formattedDateString.push(y)}break;case"M":if(tokenLen==1){formattedDateString.push(_getMonth(date,_useUTC)+1)}else{if(tokenLen==2){d=_getMonth(date,_useUTC)+1;if(String(d).length==1){formattedDateString.push(0,d)}else{formattedDateString.push(d)}}else{if(tokenLen==3){formattedDateString.push(_monthsAbbr[_locale][_getMonth(date,_useUTC)])}else{if(tokenLen==4){formattedDateString.push(_months[_locale][_getMonth(date,_useUTC)])}}}}break;case"d":var d=_getDate(date,_useUTC);for(var j=(String(d)).length;j<tokenLen;j++){formattedDateString.push("0")}formattedDateString.push(d);break;case"a":var marker=_getHours(date,_useUTC)>11?"PM":"AM";var output="";if(tokenLen==1){output=_ampmAbbr[_locale][marker]}else{output=_ampm[_locale][marker]}if(UCampm){output=output.toUpperCase()}formattedDateString.push(output);break;case"h":var hours=_getHours(date,_useUTC);formattedDateString.push(hours>12?hours-12:hours);break;case"H":formattedDateString.push(_getHours(date,_useUTC));break;case"k":formattedDateString.push(_getHours(date,_useUTC)+1);break;case"K":var hours=_getHours(date,_useUTC);formattedDateString.push(hours>=12?hours-12:hours);break;case"m":var m=_getMinutes(date,_useUTC);for(var j=(String(m)).length;j<2;j++){formattedDateString.push("0")}formattedDateString.push(m);break;case"s":var s=_getSeconds(date,_useUTC);for(var j=(String(s)).length;j<2;j++){formattedDateString.push("0")}formattedDateString.push(s);break;case"S":var ms=_getMilliseconds(date,_useUTC);for(var j=(String(ms)).length;j<4;j++){formattedDateString.push("0")}formattedDateString.push(ms);break;case"e":throw ("Unsupported string formatting token: "+c);break;case"E":var day=_getDay(date,_useUTC);if(tokenLen<=2){formattedDateString.push(_daysAbbr[_locale][day])}else{formattedDateString.push(_days[_locale][day])}break;case"D":throw ("Unsupported string formatting token: "+c);break;case"w":break;case"z":if(tokenLen>=4){throw ("Unsupported string formatting token: "+c)}else{throw ("Unsupported string formatting token: "+c)}break;case"Z":if(tokenLen==1){var tz=String(_formatTZ(date));formattedDateString.push(tz.substr(0,3)+":"+tz.substr(3,2))}else{if(tokenLen==2){formattedDateString.push(_formatTZ(date))}else{throw ("Unsupported string formatting token: "+c)}}break;case"'":var sub=token.substring(1);if(sub.length==1){formattedDateString.push(sub.charAt(0))}else{formattedDateString.push(String(sub))}break;default:throw ("Illegal pattern component: "+token)}}return formattedDateString.join("")}function _parseToken(pattern,currentIndex){var buf=[];var i=currentIndex[0];var length=pattern.length;var c=pattern.charAt(i);if(c>="A"&&c<="Z"||c>="a"&&c<="z"){buf.push(c);while(i+1<length){var peek=pattern.charAt(i+1);if(peek==c){buf.push(c);i++}else{break}}}else{buf.push("'");var inLiteral=false;for(;i<length;i++){c=pattern.charAt(i);if(c=="'"){if(i+1<length&&pattern.charAt(i+1)=="'"){i++;buf.push(c)}else{inLiteral=!inLiteral}}else{if(!inLiteral&&(c>="A"&&c<="Z"||c>="a"&&c<="z")){i--;break}else{buf.push(c)}}}}currentIndex[0]=i;return buf.join("")}function _isNumericToken(token){var tokenLen=token.length;if(tokenLen>0){var c=token.charAt(0);switch(c){case"c":case"C":case"x":case"y":case"Y":case"d":case"h":case"H":case"m":case"s":case"S":case"e":case"D":case"F":case"w":case"W":case"k":case"K":return true;case"M":if(tokenLen<=2){return true}}}return false}function _formatYear(date,useUTC){if(date.getFullYear){var newDate=new Date("January 1 2001 00:00:00 +0000");var x=_getFullYear(newDate,true);if(x==2001){return _getFullYear(date,useUTC)}}var x=date.getYear();var y=x%100;y+=(y<38)?2000:1900;return y}function _formatTZ(date){var os=Math.abs(date.getTimezoneOffset());var h=String(Math.floor(os/60));var m=String(os%60);h.length==1?h="0"+h:1;m.length==1?m="0"+m:1;return date.getTimezoneOffset()<0?"+"+h+m:"-"+h+m}function _getDate(date,useUTC){return useUTC?date.getUTCDate():date.getDate()}function _getDay(date,useUTC){return useUTC?date.getUTCDay():date.getDay()}function _getFullYear(date,useUTC){return useUTC?date.getUTCFullYear():date.getFullYear()}function _getHours(date,useUTC){return useUTC?date.getUTCHours():date.getHours()}function _getMilliseconds(date,useUTC){return useUTC?date.getMilliseconds():date.getMilliseconds()}function _getMinutes(date,useUTC){return useUTC?date.getUTCMinutes():date.getMinutes()}function _getMonth(date,useUTC){return useUTC?date.getUTCMonth():date.getMonth()}function _getSeconds(date,useUTC){return useUTC?date.getUTCSeconds():date.getSeconds()}};py.date.parse=function(input){if(_isDate(input)){return input}else{var newDate=new Date(input);if(_isDate(newDate)){return _pivotYear(newDate)}}throw ("Could not construct date from: "+input);function _isDate(dateObj){return !isNaN(dateObj.valueOf())}function _pivotYear(dateObj,pivotYear){var pivot=pivotYear!=null?pivotYear:2000;while(dateObj.getFullYear()<pivot){dateObj.setFullYear(dateObj.getFullYear()+100)}return dateObj}};Date.prototype.parseDate=function(input){try{var theDate=py.date.parse(input);this.setTime(theDate.getTime())}catch(e){return null}};Date.prototype.forPattern=function(jodaPattern,UCampm,locale,useUTC){return py.date.jodaFormat(jodaPattern,this,UCampm,locale,useUTC)};py.register("py.metrics");py.metrics.msToSeconds=function(ms){return ms/1000};py.metrics.msToMinutes=function(ms){return py.util.msToSeconds(ms)/60};py.metrics.log=function(loggerName){var data=_.extend({page_load_start_ts:py.metrics.loadStart,status:py.metrics.status,errors:py.metrics.errors.join(",")},py.metrics.attributes);console.log(py.metrics.logCount,"Log metrics for",loggerName,data);$.get("/log/"+loggerName,data);py.metrics.archivedAttributes.push({loggerName:loggerName,data:data});py.metrics.init();py.metrics.logCount++};py.metrics.msSinceLoadStart=function(){return new Date().getTime()-py.metrics.loadStart};py.metrics.addSinceStartMetric=function(name){py.metrics.add(name,py.metrics.msSinceLoadStart())};py.metrics.addSinceTimestamp=function(timestampKey,name){var timestamp=py.metrics.attributes[timestampKey]||py.metrics.loadStart;py.metrics.add(name,new Date().getTime()-timestamp)};py.metrics.addTimestampMetric=function(name){py.metrics.add(name,new Date().getTime())};py.metrics.add=function(name,value){py.metrics.attributes[name]=value};py.metrics.addError=function(error){if(!_.isArray(py.metrics.errors)){py.metrics.errors=[]}py.metrics.errors.push(error);console.error("Added error to metrics: "+error)};py.metrics.setStatus=function(status){py.metrics.status=status};py.metrics.statuses={SUCCESS:"S",ERROR:"S",DATA_ERROR:"D",TIMEOUT:"T"};py.metrics.archivedAttributes=[];py.metrics.init=function(){_.extend(py.metrics,{attributes:{},errors:[],status:py.metrics.statuses.SUCCESS})};py.metrics.logCount=0;py.metrics.init();py.loggerList=function(){var logList={};this.add=function add(logger){var key=logger.getKey();if(logList.hasOwnProperty(key)){console.warn("LoggerList: We already have a logger with key:"+key)}logList[key]=logger};this.get=function get(page,metricName){var key=page+"/"+metricName;return logList[key]};this.remove=function remove(logger){var key=logger.getKey();if(logList.hasOwnProperty(key)){delete logList[key]}}};py.loggers=new py.loggerList();py.logger=function(page,metricName,loggerName){loggerName=loggerName||"mobile_perf";var startTime;this.start=function start(customTime){startTime=customTime||(new Date()).getTime()};this.stop=function stop(customTime){var endTime=customTime||(new Date()).getTime();var data={page:page,name:metricName,start_ts:startTime,end_ts:endTime};py.loggers.remove(this)};this.getKey=function getKey(){return page+"/"+metricName};py.loggers.add(this)};$(function(){py.metrics.addSinceStartMetric("dom_ready_ms")});function css_browser_selector(u){var ua=u.toLowerCase(),is=function(t){return ua.indexOf(t)>-1},g="gecko",w="webkit",s="safari",o="opera",m="mobile",h=document.documentElement,b=[(!(/opera|webtv/i.test(ua))&&/msie\s(\d)/.test(ua))?("ie ie"+RegExp.$1):is("firefox/2")?g+" ff2":is("firefox/3.5")?g+" ff3 ff3_5":is("firefox/3.6")?g+" ff3 ff3_6":is("firefox/3")?g+" ff3":is("gecko/")?g:is("opera")?o+(/version\/(\d+)/.test(ua)?" "+o+RegExp.$1:(/opera(\s|\/)(\d+)/.test(ua)?" "+o+RegExp.$2:"")):is("konqueror")?"konqueror":is("blackberry")?m+" blackberry":is("android")?m+" android":is("chrome")?w+" chrome":is("iron")?w+" iron":is("applewebkit/")?w+" "+s+(/version\/(\d+)/.test(ua)?" "+s+RegExp.$1:""):is("mozilla/")?g:"",is("j2me")?m+" j2me":is("iphone")?m+" iphone":is("ipod")?m+" ipod":is("ipad")?m+" ipad":is("mac")?"mac":is("darwin")?"mac":is("webtv")?"webtv":is("win")?"win"+(is("windows nt 6.0")?" vista":""):is("freebsd")?"freebsd":(is("x11")||is("linux"))?"linux":"","js"];c=b.join(" ");h.className+=" "+c;return c}css_browser_selector(navigator.userAgent);_.extend(Highcharts.Chart.prototype,{SIZE_OPTIONS:{big:{width:170,height:300,daysView:1000,endPadding:40,chatbox:{path:"/img/chart/chatbox_price_prediction.png",width:165,height:210,xOffset:0,yOffset:0,contentXOffset:-4,contentYOffset:0,messageFontSize:"16px",qualifierFontSize:"14px",arrow:{yOffset:0,xOffset:0,scale:1}}},small:{width:116,height:300,daysView:90,endPadding:55,chatbox:{path:"/img/chart/chatbox_price_prediction_srp.png",width:116,height:115,xOffset:6,yOffset:-25,contentXOffset:-27,contentYOffset:-64,messageFontSize:"13px",qualifierFontSize:"12px",arrow:{yOffset:20,xOffset:8,scale:0.8}}}},MS_DAY:24*60*60*1000,DAYS_VIEW:1000,setScrollDisabled:function(){this.sizeConfig.scrollEnabled=false},scrollLeft:function(){return this.scroll(-this.DAYS_VIEW)},scrollRight:function(){return this.scroll(this.DAYS_VIEW)},rangeDays:function(){return this.convertMsToDays(this.xAxis[0].dataMax-this.xAxis[0].dataMin)},setRange:function(days){days=Math.min(this.rangeDays(),days);var daysMs=this.convertDaysToMs(days);var current=this.currentScroll();var start=Math.max(current.dataMax-daysMs,this.minX());var end=Math.min(current.dataMax,this.maxX());this.xAxis[0].setExtremes(start,end);console.log("setRange: start:",start,"end: ",end);var yExtremes=this.getYExtremesBetween(start,end);var minMax=this.enforceMinVerticalPadding({min:yExtremes.min.y,max:yExtremes.max.y});console.log("set y extremes to",minMax);this.yAxis[0].setExtremes(minMax.min,minMax.max)},getDataBetween:function(start,end){return _.filter(this.series[0].data,function(p){return(p.x>=start&&p.x<=end)})},applyChatboxPadding:function(start,end){if(this.productData.pricePrediction){var xAxis=this.xAxis[0];end+=xAxis.translate(this.paddingWidth(),true)-start;xAxis.setExtremes(start,end)}},getYExtremesBetween:function(start,end){var filtered=this.getDataBetween(start,end);var iterator=function(p){return p.y};var max=_.max(filtered,iterator);var min=_.min(filtered,iterator);return{max:max,min:min}},findNearest:function(xValue){return _.reduce(this.series[0].data,function(p,pnext){if(p){return(Math.abs(p.x-xValue)<Math.abs(pnext.x-xValue))?p:pnext}else{return pnext}},null)},scroll:function(amount){if(this.sizeConfig.scrollEnabled!==false){var current=this.currentScroll();var start=Math.max(current.min+amount,this.minX());var end=Math.min(current.max+amount,this.maxX());if(amount>0){start=end-this.DAYS_VIEW}else{end=start+this.DAYS_VIEW}this.xAxis[0].setExtremes(start,end);return[(start==this.minX()),(end==this.maxX())]}else{return[true,true]}},paddingWidth:function(){return this.sizeConfig.width+this.sizeConfig.endPadding},initExtremes:function(){var containerWidth=this.container.clientWidth;var paddingWidth=this.paddingWidth();var series=this.series[0],data=series.data,lastDate=_.last(data).x,firstDate=_.first(data).x,startDate=Math.max(firstDate,lastDate-(this.DAYS_VIEW)),boxPercent=(paddingWidth/containerWidth);var endDate=lastDate;if(startDate==firstDate){console.log("disable scrolling");this.sizeConfig.scrollEnabled=false}if(data.length<=2){startDate=firstDate;this.setScrollDisabled()}var xAxis=this.xAxis[0];xAxis.setExtremes(startDate,endDate,true,false);this.endDate=endDate;this.DAYS_VIEW=endDate-startDate},positionChatbox:function(){var lastPoint=_.last(this.series[0].data);this.chatbox.translate(lastPoint.plotX-5,0)},currentScroll:function(){return this.xAxis[0].getExtremes()},maxX:function(){return this.endDate},minX:function(){return this.series[0].data[0].x-this.MS_DAY},convertDaysToMs:function(d){return d*this.MS_DAY},convertMsToDays:function(ms){return ms/this.MS_DAY},minVerticalPaddingPercent:0.14,enforceMinVerticalPadding:function(point){var padding=this.minVerticalPaddingPercent*(point.max-point.min);var min=point.min-padding;var max=point.max+padding;if((max-min)<40){max+=20;min-=20}min=Math.max(min,0);return{min:min,max:max}}});
/*!
*  Base64 encode / decode
*  http://www.webtoolkit.info/
*/
var Base64={_keyStr:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=",encode:function(input){var output="";var chr1,chr2,chr3,enc1,enc2,enc3,enc4;var i=0;input=Base64._utf8_encode(input);while(i<input.length){chr1=input.charCodeAt(i++);chr2=input.charCodeAt(i++);chr3=input.charCodeAt(i++);enc1=chr1>>2;enc2=((chr1&3)<<4)|(chr2>>4);enc3=((chr2&15)<<2)|(chr3>>6);enc4=chr3&63;if(isNaN(chr2)){enc3=enc4=64}else{if(isNaN(chr3)){enc4=64}}output=output+this._keyStr.charAt(enc1)+this._keyStr.charAt(enc2)+this._keyStr.charAt(enc3)+this._keyStr.charAt(enc4)}return output},decode:function(input){var output="";var chr1,chr2,chr3;var enc1,enc2,enc3,enc4;var i=0;input=input.replace(/[^A-Za-z0-9\+\/\=]/g,"");while(i<input.length){enc1=this._keyStr.indexOf(input.charAt(i++));enc2=this._keyStr.indexOf(input.charAt(i++));enc3=this._keyStr.indexOf(input.charAt(i++));enc4=this._keyStr.indexOf(input.charAt(i++));chr1=(enc1<<2)|(enc2>>4);chr2=((enc2&15)<<4)|(enc3>>2);chr3=((enc3&3)<<6)|enc4;output=output+String.fromCharCode(chr1);if(enc3!=64){output=output+String.fromCharCode(chr2)}if(enc4!=64){output=output+String.fromCharCode(chr3)}}output=Base64._utf8_decode(output);return output},_utf8_encode:function(string){string=string.replace(/\r\n/g,"\n");var utftext="";for(var n=0;n<string.length;n++){var c=string.charCodeAt(n);if(c<128){utftext+=String.fromCharCode(c)}else{if((c>127)&&(c<2048)){utftext+=String.fromCharCode((c>>6)|192);utftext+=String.fromCharCode((c&63)|128)}else{utftext+=String.fromCharCode((c>>12)|224);utftext+=String.fromCharCode(((c>>6)&63)|128);utftext+=String.fromCharCode((c&63)|128)}}}return utftext},_utf8_decode:function(utftext){var string="";var i=0;var c=c1=c2=0;while(i<utftext.length){c=utftext.charCodeAt(i);if(c<128){string+=String.fromCharCode(c);i++}else{if((c>191)&&(c<224)){c2=utftext.charCodeAt(i+1);string+=String.fromCharCode(((c&31)<<6)|(c2&63));i+=2}else{c2=utftext.charCodeAt(i+1);c3=utftext.charCodeAt(i+2);string+=String.fromCharCode(((c&15)<<12)|((c2&63)<<6)|(c3&63));i+=3}}}return string}};ns("decide.util").udc=(function(){var udcCookieName="udc";var udcCookiePath="/";var udcCookieExpiresDays=90;var udc={};var parseMaxReloadAttempts=2;function _reload(){var encodedCookie=$.cookie(udcCookieName);if(encodedCookie==null){udc={};return}var udcCookie=Base64.decode(encodedCookie);var retryCount=0;if(!JSON){throw"could not parse JSON from cookie"}udc=JSON.parse(udcCookie);while(!(udc instanceof Object)&&retryCount<parseMaxReloadAttempts){udc=JSON.parse(udc);retryCount++}if(!(udc instanceof Object)){console.warn("Could not initialize udc. Retried json parsing "+retryCount+" times.")}}_reload();return{reload:_reload,setValue:function(name,value){udc[name]=value;var encoded=Base64.encode(JSON.stringify(udc));$.cookie(udcCookieName,encoded,{expires:udcCookieExpiresDays,path:udcCookiePath});return udc},getValue:function(name){return udc[name]},getUdc:function(){return udc}}})();ns("py.util").udc=decide.util.udc;
/*!
 * from https://gist.github.com/822382
 */
function DecimalFormat(formatStr){this.prefix="";this.suffix="";this.comma=0;this.minInt=1;this.minFrac=0;this.maxFrac=0;for(var i=0;i<formatStr.length;i++){if(formatStr.charAt(i)=="#"||formatStr.charAt(i)=="0"){this.prefix=formatStr.substring(0,i);formatStr=formatStr.substring(i);break}}this.suffix=formatStr.replace(/[#]|[0]|[,]|[.]/g,"");var numberStr=formatStr.replace(/[^0#,.]/g,"");var intStr="";var fracStr="";var point=numberStr.indexOf(".");if(point!=-1){intStr=numberStr.substring(0,point);fracStr=numberStr.substring(point+1)}else{intStr=numberStr}var commaPos=intStr.lastIndexOf(",");if(commaPos!=-1){this.comma=intStr.length-1-commaPos}intStr=intStr.replace(/[,]/g,"");fracStr=fracStr.replace(/[,]|[.]+/g,"");this.maxFrac=fracStr.length;var tmp=intStr.replace(/[^0]/g,"");if(tmp.length>this.minInt){this.minInt=tmp.length}tmp=fracStr.replace(/[^0]/g,"");this.minFrac=tmp.length}DecimalFormat.prototype.format=function(numStr){var numberStr=this.formatBack(numStr).toLowerCase();if(isNaN(numberStr)||numberStr.length==0){return numStr}if(i=numberStr.indexOf("e")!=-1){var n=Number(numberStr);if(n=="Infinity"||n=="-Infinity"){return numberStr}numberStr=n+"";if(numberStr.indexOf("e")!=-1){return numberStr}}var negative=false;if(numberStr.charAt(0)=="-"){negative=true;numberStr=numberStr.substring(1)}else{if(numberStr.charAt(0)=="+"){numberStr=numberStr.substring(1)}}var point=numberStr.indexOf(".");var intStr="";var fracStr="";if(point!=-1){intStr=numberStr.substring(0,point);fracStr=numberStr.substring(point+1)}else{intStr=numberStr}fracStr=fracStr.replace(/[.]/,"");var isPercentage=this.suffix&&this.suffix.charAt(0)==="%";var minInt=this.minInt,minFrac=this.minFrac,maxFrac=this.maxFrac;if(isPercentage){minInt-=2;minFrac+=2;maxFrac+=2}if(fracStr.length>maxFrac){var num=new Number("0."+fracStr);num=(maxFrac==0)?Math.round(num):num.toFixed(maxFrac);fracStr=num.toString(10).substr(2);var c=(num>=1)?1:0;var x,i=intStr.length-1;while(c){if(i==-1){intStr="1"+intStr;break}else{x=intStr.charAt(i);if(x==9){x="0";c=1}else{x=(++x)+"";c=0}intStr=intStr.substring(0,i)+x+intStr.substring(i+1,intStr.length);i--}}}for(var i=fracStr.length;i<minFrac;i++){fracStr=fracStr+"0"}while(fracStr.length>minFrac&&fracStr.charAt(fracStr.length-1)=="0"){fracStr=fracStr.substring(0,fracStr.length-1)}for(var i=intStr.length;i<minInt;i++){intStr="0"+intStr}while(intStr.length>minInt&&intStr.charAt(0)=="0"){intStr=intStr.substring(1)}if(isPercentage){intStr+=fracStr.substring(0,2);fracStr=fracStr.substring(2)}var j=0;for(var i=intStr.length;i>0;i--){if(j!=0&&j%this.comma==0){intStr=intStr.substring(0,i)+","+intStr.substring(i);j=0}j++}var formattedValue;if(fracStr.length>0){formattedValue=this.prefix+intStr+"."+fracStr+this.suffix}else{formattedValue=this.prefix+intStr+this.suffix}if(negative){formattedValue="-"+formattedValue}return formattedValue};DecimalFormat.prototype.formatBack=function(fNumStr){if(!fNumStr&&fNumStr!==0){return""}fNumStr+="";if(!isNaN(fNumStr)){return this.getNumericString(fNumStr)}var fNumberStr=fNumStr;var negative=false;if(fNumStr.charAt(0)=="-"){fNumberStr=fNumberStr.substr(1);negative=true}var pIndex=fNumberStr.indexOf(this.prefix);var sIndex=(this.suffix=="")?fNumberStr.length:fNumberStr.indexOf(this.suffix,this.prefix.length+1);if(pIndex==0&&sIndex>0){fNumberStr=fNumberStr.substr(0,sIndex);fNumberStr=fNumberStr.substr(this.prefix.length);fNumberStr=fNumberStr.replace(/,/g,"");if(negative){fNumberStr="-"+fNumberStr}if(!isNaN(fNumberStr)){return this.getNumericString(fNumberStr)}}return fNumStr};DecimalFormat.prototype.getNumericString=function(str){var num=new Number(str);var numStr=num+"";if(str.indexOf(".")>-1&&numStr.indexOf(".")<0){for(var i=str.indexOf(".")+1;i<str.length;i++){if(str.charAt(i)!=="0"){return str}}return numStr}return str};py.register("py.helpers");py.register("py.colors");py.colors={GREEN:"#009107",RED:"#bf0600",NEUTRAL:"#b5d7ef",GRAY:"#666666"};py.helpers=new function(){this.numberToCssClass=function(num){num=(Math.round(num*2)/2)||0;return num.toString().replace(".","_")};var messageTypes={PRICE:"priceMessaging",MODEL:"modelMessaging"};this.isConflictedModelPrediction=function(productRecommendation,modelPrediction){if(productRecommendation===null||modelPrediction===null){return false}var isConflicted=false;var tip=productRecommendation.tip.toUpperCase();if(productRecommendation.poweredBy!="PRICE_PREDICTION"){return false}if(tip=="WAIT"){if(modelPrediction.newModelComingSoon!==true){isConflicted=true}}if(tip=="BUY"){if(modelPrediction.newModelComingSoon===true){isConflicted=true}}return isConflicted};this.isConflictedPricePrediction=function(productRecommendation,pricePrediction){var isConflicted=false;if(!(productRecommendation&&pricePrediction)){return isConflicted}if(productRecommendation.poweredBy=="PRICE_PREDICTION"){return false}var tip=productRecommendation.tip;var arrow=pricePrediction.arrow;if(tip=="WAIT"){if(arrow=="UP"||arrow=="UP_FLAT"||arrow=="FLAT"){isConflicted=true}}else{if(tip=="BUY"){if(arrow=="DOWN"||arrow=="DOWN_FLAT"){isConflicted=true}}}return isConflicted};this.getPrimaryColor=function(tip){if(tip.toUpperCase()==="WAIT"){return py.colors.RED}else{return py.colors.GREEN}};this.getSecondaryPriceColor=function(productRecommendation,pricePrediction){var tip=productRecommendation.tip;var arrow=pricePrediction.arrow;var color;if(tip=="WAIT"){color=py.colors.RED}else{if(tip=="BUY"){color=py.colors.GREEN}}if(this.isConflictedPricePrediction(productRecommendation,pricePrediction)){color=py.colors.GRAY}return color};this.getArrowImagePath=function(pricePrediction,productRecommendation,conflicts){conflicts=conflicts||false;var arrow=pricePrediction.arrow;var tip=productRecommendation.tip;var path="/img/chart/arrow_";if(typeof(PhoneGap)!=="undefined"){path=(py.ENDPOINT||"http://www.decide.com")+path}if(arrow=="UP"||arrow=="UP_FLAT"){path+="up"}else{if(arrow=="FLAT"){path+="flat"}else{path+="down"}}path+="_neutral";return path+".png"};this.buildRecommendationKey=function(product,messageType){var fragments=["","","","",messageTypes[messageType]];var pr=product.productRecommendation,action=(pr&&pr.action)?pr.action:"",tip=(pr&&pr.tip)?pr.tip:"";var pp=product.pricePrediction,mp=product.modelPrediction;if(messageType=="MODEL"){if(this.isProductUnreleased(product)){return"PREORDER."+messageTypes[messageType]}else{if(action=="NEW_MODEL_RUMOR_ALERT"){return"NEWS_OR_RUMOR"}}}if(action=="RESEARCH_NEWER_MODEL"&&messageType=="MODEL"){fragments[0]="FALSE"}else{fragments[0]="TRUE"}if(action=="RESEARCH_NEWER_MODEL"&&messageType!="PRICE"){if(pr&&pr.newerModelRelativePrice){fragments[1]=pr.newerModelRelativePrice}else{fragments[1]="NONE"}}else{fragments[1]="ANY"}if(messageType=="MODEL"&&fragments[0]==="FALSE"){fragments[2]="ANY";fragments[3]="ANY"}else{if(messageType==="MODEL"){fragments[2]="ANY"}else{if(pp&&pp.arrow){fragments[2]=pp.arrow}else{fragments[2]="NONE"}}if(messageType==="PRICE"){fragments[3]="ANY"}else{if(mp&&mp.newModelComingSoon!==null){fragments[3]=mp.newModelComingSoon.toString().toUpperCase()}else{fragments[3]="NONE"}}}return fragments.join(".")};this.isProductUnreleased=function(product){var pr=product.productRecommendation;var action=(pr&&pr.action)?pr.action:"";return(product.offerSummary&&product.offerSummary.preOrder)||(product.productReleaseDate&&this.parseLocalDate(product.productReleaseDate)>new Date())||action==="RESEARCH_NEWER_MODEL_PRE_ORDER"};this.parseLocalDate=function(localDate){if(!(localDate&&$.isArray(localDate)&&localDate.length>=3)){return null}return new Date(localDate[0],localDate[1]-1,localDate[2])};this.formatPercentage=function(p){return Math.round(p*100)+"%"};this.roundNumber=function(num,dec){var result=Math.round(num*Math.pow(10,dec))/Math.pow(10,dec);return result};this.string={toClassName:function(s){return s.toLowerCase().replace(/[^\w+]/g,"_")}};var escapeMap={"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"};this.escapeHTML=function(string){return String(string).replace(/&(?!\w+;)|[<>"']/g,function(s){return escapeMap[s]||s})}};ns("decide").helpers=py.helpers;ns("decide.helpers").multiStringEllipsis=function(strings,count){var ellipsizedStrings=[];if((strings[0]+strings[1]).length<count){ellipsizedStrings=strings}else{if(strings[0].length<count&&strings[1]&&strings[1].length>count-10){ellipsizedStrings[0]=strings[0];ellipsizedStrings[1]=this.ellipsis(strings[1].substring(0,count-strings[0].length-10).trim())}else{ellipsizedStrings[0]=this.ellipsis(strings[0].substring(0,count-10).trim());ellipsizedStrings[1]=""}}return ellipsizedStrings};ns("decide.helpers").ellipsis=function(string){return string+"..."};ns("decide.helpers").splitFirst=(function(){return function(text,splitOn){var index=text.indexOf(splitOn);var beforeSplit=text.substring(0,index);var afterSplit=text.substring(index+1,text.length);return[beforeSplit,afterSplit]}}());ns("decide.util.dom",{scrollTop:function(shouldAnimate){if(document.body.scrollTop!==0){if(shouldAnimate){$("body").animate({scrollTop:0},"slow")}else{window.scrollTo(0,0)}}}});ns("decide").ga=new function(){this.plugin=null;this.usePlugin=false;this.init=function init(){if(window.plugins&&window.plugins.googleAnalyticsPlugin){this.plugin=window.plugins.googleAnalyticsPlugin;console.log("found window.plugins.googleAnalyticsPlugin")}this.usePlugin=typeof(this.plugin)!=="undefined"};this.trackFullEvent=function trackEvent(category,action,label,value,noninteraction){if(this.usePlugin&&this.plugin&&this.plugin.trackEvent){this.plugin.trackEvent(category,action,label,value)}else{if(typeof(_gaq)==="object"){var args=["_trackEvent",category,action,label,value,(!!noninteraction).toString];_gaq.push(args);if($.cookie("decide.debugGaEvents")){var template="GATrackEvent[category:[{{category}}] action:[{{action}}] label:[{{label}}] value:[{{value}}]] noninteraction:[{{noninteraction}}]";var message=$.mustache(template,{category:category,action:action,label:label,value:value,noninteraction:noninteraction});alert(message)}}else{console.log("neither _gaq or window.plugins.googleAnalyticsPlugin were available for tracking")}}};this.trackEvent=function trackEvent(category,action,label,value){this.trackFullEvent(category,action,label,value,null)};this.trackPageview=function trackPageview(page){if(this.usePlugin){this.plugin.trackPageview(page)}else{if(typeof(_gaq)==="object"){var args=["_trackPageview"];if(typeof(page)!=="undefined"){args.push(page)}if($.cookie("decide.debugGaViews")){var template="GATrackViews[{{args}}]";var message=$.mustache(template,{args:args.join(", ")});alert(message)}_gaq.push(args);if($.cookie("decide.debugGaViewsAfter")){var template="GATrackViewsAfter[{{args}}]";var message=$.mustache(template,{args:args.join(", ")});alert(message)}}else{console.log("neither _gaq or window.plugins.googleAnalyticsPlugin were available for tracking")}}}};if(decide.env.isPhoneGap()){document.addEventListener("deviceready",function initGA(){py.util.ga.init()},false)}ns("py.util").ga=decide.ga;$(function(){$(document).on("click","[data-ga=click]",function(event){var $target=$(event.currentTarget);var pageInfo=decide.pageInfo;var category=pageInfo.find($target.data("categoryKey"))||$target.data("category");var action=pageInfo.find($target.data("actionKey"))||$target.data("action");var label=pageInfo.find($target.data("labelKey"))||$target.data("label");var value=pageInfo.find($target.data("valueKey"))||$target.data("value");var noninteraction=_.isUndefined($target.data("noninteraction"))?null:!!$target.data("noninteraction");decide.ga.trackFullEvent(category,action,label,value,noninteraction)});$(document).on("click","[data-ga=event]",function(event){forwardEventToBus(event)});$(document).on("submit","[data-ga=submit]",function(event){forwardEventToBus(event)});var forwardEventToBus=function(event){var $target=$(event.currentTarget);var eventName=$target.data("event");if(_.isEmpty(eventName)){console.log("Event missing name. ",$target);return}var eventData=$target.data();eventData.target=$target;decide.eventBus.trigger(eventName,$target.data())};decide.eventBus.on("user:interaction",function(event){decide.ga.trackEvent("signup interactions",event.action,event.label,null)});decide.eventBus.on("signup:success",function(event){decide.ga.trackEvent("signup",event.signupState.signupMethod,event.summary,null)});decide.eventBus.on("signup:fail",function(event){decide.ga.trackEvent("signup-fail",event.signupState.signupMethod,event.errorMessage,null)});decide.eventBus.on("free-prediction",function(event){decide.ga.trackEvent("free-prediction",event.action,null,null)});decide.eventBus.on("signup:free-prediction",function(event){decide.ga.trackEvent("free-prediction-signup",event.action,null,null)});decide.eventBus.on("lightbox",function(event){decide.ga.trackEvent("signup box",event.isOpen?"open":"close",event.summary,null)});decide.eventBus.on("pg-lightbox",function(event){decide.ga.trackEvent("pg lightbox",event.action,event.label,null)});decide.eventBus.on("prompt-lightbox",function(event){decide.ga.trackEvent("prompt-lightbox",event.action,event.label,null)});decide.eventBus.on("referral-lightbox",function(event){decide.ga.trackEvent("referral-lightbox",event.action,event.label,null)});decide.eventBus.on("banner:shown",function(event){decide.ga.trackEvent("grid-banner",event.banner,"show",null)});decide.eventBus.on("variants-link-prod",function(event){decide.ga.trackEvent("variants-link-prod",event.action,event.label,null)});decide.eventBus.on("variants-link-search",function(event){decide.ga.trackEvent("variants-link-search",event.action,event.label,null)});decide.eventBus.on("variants-lightbox",function(event){decide.ga.trackEvent("variants-lightbox",decide.pageInfo.find("view"),event.label,null)});decide.eventBus.on("herousel:pane:shown",function(event){decide.ga.trackEvent("homepage","slideshow_view",event.pane,null)});decide.eventBus.on("paid-confirm",function(event){decide.ga.trackEvent("paid-confirm",event.action,null,null)});decide.eventBus.on("signupBox",function(event){var action=event.action;var view=decide.pageInfo.find("view");decide.ga.trackEvent("signup box",action,view,null)});decide.eventBus.on("browseSearch",function(event){var query=event.query;var view=event.view;decide.ga.trackEvent("search",view.trim()=="show"?"product":view,query,null);decide.ga.trackEvent("browse",query,null,null)});decide.eventBus.on("productTile",function(event){decide.ga.trackEvent("how it compares",event.parentScore,event.score,null)});decide.eventBus.on("productTileSRP",function(event){decide.ga.trackEvent("tile clicks on srp",event.clickArea,event.title,null);if(event.gaClick){decide.ga.trackEvent(event.category,event.action,event.label,null)}});decide.eventBus.on("searchPage",function(event){var query=event.query;var view=decide.pageInfo.find("view");decide.ga.trackEvent("search",view.trim()=="show"?"product":view,query,null)});decide.eventBus.on("searchForm",function(event){var $target=event.target;var isForm=$target.hasClass("search_form");var form=isForm?$target:$target.parents(".search_form:first");var query=form.find(".query_input").val();var page=decide.pageInfo.find("view");decide.ga.trackEvent("search",page.trim()=="show"?"product":page,query,null)});decide.eventBus.on("product:partnerClick",function(event){var category=decide.pageInfo.find("productCategoryName");var source=event.source;var sellerName=event.sellername;var price=typeof event.price=="number"?event.price:!_.isEmpty(event.price)&&parseFloat(event.price.replace(/[^0-9\.]/g,""));decide.ga.trackEvent("partner click",category,sellerName,price);decide.ga.trackFullEvent("partner location clicks",source,category,null,true)});decide.eventBus.on("user:alert",function(event){var action=event.action;var categoryName=decide.pageInfo.find("productCategoryName");decide.ga.trackEvent("alert",action,categoryName,null)});decide.eventBus.on("banner",function(event){var action=event.action;decide.ga.trackEvent("banner",action)});var pageType=$("body").attr("class");$(".when").click(function(){trackHpContent($(this),"learn more","/how-it-works")});$(document).on("click",".top_products li",function(event){trackHpContent($(this),"products")});var srpCategory=function(){return $(".facet_container > .facet_name span").first().text()};var trackHpContent=function($target,action,url){var label=$target.find("a").length?$target.find("a").attr("href"):url||"";decide.ga.trackEvent("hp content",action,label)};var lastProductId=null;$(document).on("jsp-scroll-y",".scrollpane",function(){var $current=$(".product_list_item.active");var productId=$current.find(".product").data("id");var product=$current.find(".product_title").text();var rank=$(".product_list_item").index($current)+1;if($(this).find(".jspPane").css("top")!="0px"&&(lastProductId!=productId)){decide.ga.trackEvent("srp result click","scroll down",product,rank,true);lastProductId=productId}});$(document).off("gaShowMisspelling").on("gaShowMisspelling",function(e){decide.ga.trackEvent("srp compare module","mispelled module shown");e.stopPropagation()});$(document).on({gaSrpMore:function(e,nextResult){var selectedProduct=$(".product_list_item.active").find(".product_title").text();var category=srpCategory();decide.ga.trackEvent("srp more",category,selectedProduct,nextResult)}});$('.price_info a[href^="/p"]').on("click",function(e){if($el.closest(".btn-group").hasClass("online")){decide.ga.trackEvent("button",pageType,"online")}else{decide.ga.trackEvent("button",pageType,"nearby")}});$(".compare_prices td a").live("click",function(e){if(!$(this).hasClass("all")){}else{if($(this).find("a").attr("href")==="#nearby"){decide.ga.trackEvent("button",pageType,"nearby see more")}else{decide.ga.trackEvent("button",pageType,"online see more")}}});$(".local").on("click",".store_info .title a",function(){var merchant=$(this).parent(".title").find("a:first").text();decide.ga.trackEvent("local click",$(".set_alert").data("category"),merchant)});$(document).on("gaSort",function(e,sort_option){var category=srpCategory();decide.ga.trackEvent("sort",category,sort_option)});$(document).on("lightboxClosed",function(event){var lightboxTitle=event.title;if(lightboxTitle==="Set a Password"){decide.ga.trackEvent("set password box","close")}});$("#filter").on("click.filter",".facet_list li",function(e){var productCategory=srpCategory();var filterName=$(this).parents(".facet_container").find("h4").text();var filterValue=$(this).find(".facet_name").text();decide.ga.trackEvent("srp filter",productCategory,filterName);decide.ga.trackEvent("srp filter detail",productCategory,filterValue,0,true)});$(".mispelling").on("click.showing",".showing a",function(){decide.ga.trackEvent("srp compare module","mispelled query","Correct: "+$(this).attr("data-query"))});$(".mispelling").on("click.instead",".instead a",function(){decide.ga.trackEvent("srp compare module","mispelled query","Incorrect: "+$(this).attr("data-query"))});$("footer").on("click","a",function(){var target=$(this).text().toLowerCase();decide.ga.trackEvent("footer",pageType,target)});$("#ki_tab a").live("click",function(){decide.ga.trackEvent("feedback",pageType,0,4)});$(".download a").click(function(){trackDownload($(this),(".download a"))});$("#mobile-side .store_links a").click(function(){trackDownload($(this),("#mobile-side .store_links a"))});$("#headline a").click(function(){trackDownload($(this),("#headline a"))});$(".ui-menu-item").live("click",function(){var position=$(".ui-menu-item").index($(this))+1;decide.ga.trackEvent("autocomplete",pageType,$(this).text(),position,true)});$(".news_and_rumors_item a").live("click",function(){var $target=$(this).parents(".news_and_rumors_item");var index=$(".news_and_rumors_item").index($target)+1;if($("#news_and_rumors_items").find(".rumors_item_wrapper").length!=0){index--}var url='"'+$(this).attr("href")+'"';decide.ga.trackEvent("news and rumors","product "+index,url)});$(".category_rumors a").live("click",function(){var $target=$(this).parents(".item");var index=$(".events .item").index($target)+1;var url='"'+($target).data("url")+'"';decide.ga.trackEvent("news and rumors","category"+index,url)});$(".model_content a").live("click",function(){var clickedRow=$(this).closest("td");var currentRow=$(clickedRow).parent().find("td.current");var previousEntries=0;var prevRows=$(currentRow).prevAll();for(var i=0;i<prevRows.length;i++){var modelRow=prevRows[i];var model=$(modelRow);previousEntries++;if(model.data("id")===clickedRow.data("id")){break}}decide.ga.trackEvent("model history",previousEntries,$(this).attr("alt"))});$(".product_nav a").live("click",function(){var label=$(this).parents(".product_nav").hasClass("fixed")?"sticky":"not sticky";decide.ga.trackEvent("product page nav",$(this).text(),label)});$(document).on("click",".product_panels a",function(){var action=null;if($(this).parent().hasClass("title")&&$(this).parent().is("h1")){action="product title"}else{if($(this).parent().hasClass("product_rank")){action="category rank"}else{if($(this).parent().hasClass("rating_info")){action="reviews"}else{if($(this).parents(".prediction_module").find(".price_chart_container").length!=0){action="price_prediction"}else{if($(this).parents(".prediction_module").find(".model_history_container").length!=0){if($(this).parent().hasClass("prediction")){action="model_prediction"}else{action=$(this).text().toLowerCase()}}}}}}if(action!=null){decide.ga.trackEvent("pane clicks",action)}});var rightRailTracker=(function(){_params={};_registerTextAds=function(){$(document).on("rail:showTextAds",function(event,categoryName){console.log("rail:showTextAds");decide.ga.trackEvent("rail","text shown",categoryName)})};_registerCompare=function(){$(document).on("rail:showCompare",function(event,categoryName){console.log("rail:showCompare");decide.ga.trackEvent("rail","rec shown",categoryName)})};_registerPriceDrops=function(){$(document).on("rail:showPriceDrops",function(event,categoryName){console.log("rail:showPriceDrops");decide.ga.trackEvent("rail","price drops shown",categoryName)})};_registerClicks=function(){$(document).on("click",".rail a",function(){var rail_label=$("#compare_pane").is(":visible")?"rec shown":"price drops shown";decide.ga.trackEvent("rail",rail_label,srpCategory());console.log("click right rail");if($(this).parents(".feed").hasClass("PRODUCT_NEWS")){var rank=$(".events .item").index($(this).parents(".item"))+1;console.log("rail price drop clicks news "+rank);_gaq.push(["_trackEvent","rail price drop clicks","news "+rank,$(this).attr("href")])}else{if($(this).parents(".feed").hasClass("PRICE_DROP")){var rank=$(".events .item").index($(this).parents(".item"))+1;console.log("rail price drop clicks price "+rank);_gaq.push(["_trackEvent","rail price drop clicks","price "+rank,$(this).attr("href")])}else{if($(".compared_products .product").index($(this).parents(".product"))===0){var title=$(this).parents(".product").find(".header").text();console.log("rail rec clicks top "+title);decide.ga.trackEvent("rail rec clicks","top",title)}else{if($(".compared_products .product").index($(this).parents(".product"))===1){var title=$(this).parents(".product").find(".header").text();console.log("rail rec clicks bot "+title);decide.ga.trackEvent("rail rec clicks","bot",title)}}}}})};my={};my.init=function(params){_params=params};my.registerTrackers=function(){_registerTextAds();_registerCompare();_registerPriceDrops();_registerClicks()};return my}());rightRailTracker.init({});rightRailTracker.registerTrackers();var gybGaEventTracker=(function(){var pub={};pub.init=function init(params){};pub.registerTrackers=function registerTrackers(){_trackEntries();_trackFAQ();_trackGYBAvailability();_trackBuyButton();_trackDealClick();_trackShareClick()};var _trackEntries=function _trackEntries(){$(document).on("click","#deals_banner a",function(){console.log("Tracked click on search banner. PageType="+_getPageType());decide.ga.trackEvent("Entry","page header",_getPageType(),null)});$(document).on("click","button#gyb",function(){console.log("Tracked click on GYB button. PageType="+_getPageType());decide.ga.trackEvent("Entry","prod header",_getPageType(),null)});$(document).on("click",".carousel #gybHomeButton",function(){console.log("Tracked click on GYB home button. PageType="+_getPageType());decide.ga.trackEvent("Entry","home button",_getPageType(),null)});$(document).on("click",".carousel #gybHomeImage",function(){console.log("Tracked click on GYB home button. PageType="+_getPageType());decide.ga.trackEvent("Entry","home image",_getPageType(),null)});$(document).on("click",".categories #gybNavLink",function(){console.log("Tracked click on GYB nav link. PageType="+_getPageType());decide.ga.trackEvent("Entry","nav link",_getPageType(),null)})};var _trackFAQ=function _trackFAQ(){$(document).on("click","section#hero #step3 a",function(){console.log("Tracked click on FAQ open.");decide.ga.trackEvent("FAQ","open",null,null)});$(document).on("click","#faq .dismiss-faq",function(){console.log("Tracked click on FAQ close.");decide.ga.trackEvent("FAQ","close",null,null)})};var _trackGYBAvailability=function _trackGYBAvailability(){console.log("Track GYB Availability");$(document).on("GYBHeroShown",function(event){var available=_getHeroIsAvailable();var availableText=available?"Yes":"No";var productName=_getGYBPageProductName();console.log("Tracked GYB Hero Appeared. availableText="+availableText+" | productName="+productName);decide.ga.trackEvent("GYB Available",availableText,productName,null)})};var _trackBuyButton=function _trackBuyButton(){$(document).on("click","section#hero a#buy_button",function(element){var category=_getGYBPageCategoryName();var productTitle=_getGYBPageProductName();console.log("Track buy button. category="+category+" | productTitle="+productTitle);decide.ga.trackEvent("Buy Now",category,productTitle,null)})};var _trackDealClick=function _trackDealClick(){$(document).on("GYBOfferSelected",function(event){var pageType=_getPageType();var row=event.offerIndex;var categoryName=event.offerCategoryName;console.log("Track deal click. row="+row+" | categoryName="+categoryName+" | pageType="+pageType);if(pageType=="home"){var action="product"+row;decide.ga.trackEvent("Entry",action,pageType,null)}else{decide.ga.trackEvent("Deal click",row,categoryName,null)}})};var _trackShareClick=function _trackShareClick(){$(document).on("click","#gyb_share a",function(element){var productTitle=_getGYBPageProductName();console.log("Clicked Share Pin. Title="+productTitle);decide.ga.trackEvent("Share","pin",productTitle,null)})};var _getGYBPageCategoryName=function _getGYBPageCategoryName(){return $("section#hero").data("category")};var _getGYBPageProductName=function _getGYBPageCategoryName(){return $("section#hero").data("productName")};var _getHeroIsAvailable=function _getGYBPageIsAvailable(){return !($("section#hero").data("unavailable"))};var _getPageType=function _getPageType(){return $("body").data("view")};return pub}());gybGaEventTracker.init({});gybGaEventTracker.registerTrackers()});ns("decide.util").facebook={load:function load(){if(typeof(FB)==="undefined"&&typeof(PhoneGap)==="undefined"){window.fbAsyncInit=function(){console.log("Initializing the Facebook JS SDK");FB.init({appId:$("meta[name=facebook_app_id]").attr("content")});$(document).trigger("facebook:ready")};$("body").append('<div id="fb-root"></div>');console.log("Downloading the Facebook JS SDK");$.getScript(document.location.protocol+"//connect.facebook.net/en_US/all.js")}}};ns("decide").formatters=(function(){var format=decide.message.formatter.format;var instance;var init=function(){return{string:decide.helpers.string,format:decide.message.formatter.format,formatPlural:decide.message.formatter.formatPlural,formatPluralWithArgs:decide.message.formatter.formatPluralWithArgs,formatNumber:{priceCents:new DecimalFormat(format("number.priceCents")),priceCentsOnly:new DecimalFormat(format("number.priceCentsOnly")),priceNoCents:new DecimalFormat(format("number.priceNoCents")),noDecimal:new DecimalFormat(format("number.noDecimal")),percentageNoDecimal:new DecimalFormat(format("number.percentageNoDecimal")),priceSmartCents:function(amount){return(amount<1)?this.numberFormatter.priceCentsOnly.format(amount*100):this.numberFormatter.priceNoCents.format(amount)}}}};return{get:function(){return instance||(instance=init())}}})();ns("decide").ApplicationBase={classInfo:function(instance){instance||(instance=this);var classMap={ApplicationView:"decide.views",ApplicationModel:"decide.models",ApplicationRouter:"decide.routers",ApplicationCollection:"decide.collections"};var nsToSearch=_.find(classMap,function(v,k){return instance instanceof ns("decide")[k]});var namespaceMap={};var partitionClassesAndNamespaces=function(nsObj){var subnamespaces={},classes={};_.each(nsObj,function(v,k){if(!_.isFunction(v)&&_.isObject(v)&&!_.isEmpty(v)){namespaceMap[v]=k;subnamespaces[k]=v}else{if(_.isFunction(v)){classes[k]=v}}});return{subnamespaces:subnamespaces,classes:classes}};var recurseCount=0;var searchNs=function(nsObj,inst){if(recurseCount++>100){console.error("Recursed over 100 times. The namespace must be messed up. Did you accidentally mix something nasty into it?");return}var partitioned=partitionClassesAndNamespaces(nsObj),subnamespaces=partitioned.subnamespaces,classes=partitioned.classes;var className;var childClass=_.find(classes,function(v,k){return inst instanceof v&&(className=k)});return childClass?{name:className,childClass:childClass,namespace:nsObj,qualifiedClassName:nsToSearch+"."+(namespaceMap[nsObj]?namespaceMap[nsObj]+".":"")+className}:subnamespaces?recurseNs(subnamespaces,inst):null};var recurseNs=function(subnamespaces,inst){var result;_.each(subnamespaces,function(v){var ret=searchNs(v,inst);if(ret){result=ret}});return result};return(decide.applicationEnv.indexOf("dev")===0)?searchNs(ns(nsToSearch),instance):{name:"classInfo is only enabled in dev-mode",childClass:"classInfo is only enabled in dev-mode",qualifiedClassName:"classInfo is only enabled in dev-mode",namespace:{}}},toString:function(){var ci=this.classInfo();return ci?ci.qualifiedClassName:this},encodeURIComponent:function(s){return encodeURIComponent(s)},encodeURI:function(s){return encodeURI(s.toString().replace(/ /g,"+"))}};ns("decide").ApplicationRouter=Backbone.Router.extend({constructor:function(){_.extend(this,decide.ApplicationBase);if(!decide.user){decide.user=new decide.models.User()}decide.signupState=new decide.models.SignupState();decide.flashMessages=new decide.collections.FlashMessageCollection();this.browseMenu=new decide.views.BrowseMenu();this.dashboard=new decide.views.Dashboard();this.flashMessage=new decide.views.FlashMessage({el:"#flash_message",collection:decide.flashMessages});this.forgotPassword=new decide.views.ForgotPassword({el:$("#forgot_password_page_contents"),model:decide.user});this.lightboxGate=new decide.views.LightboxGate({el:$("#lightboxGate"),model:decide.user});this.lightboxRegistrationPrompt=new decide.views.LightboxRegistrationPrompt();this.lightboxSuggestBrowser=new decide.views.LightboxSuggestBrowser();this.login=new decide.views.LoginPage({el:$("#session_page_contents"),model:decide.user});this.nav=new decide.views.Nav({model:new decide.ApplicationModel(),el:$("#header_wrapper")});this.signup=new decide.views.SignUpPage({el:$("#account_page_contents"),model:decide.user});this.userNav=new decide.views.UserNav({model:decide.user,el:$(".user")});this.videoPlayer=new decide.views.VideoPlayer();this.iosHelper=new decide.views.iOSHelper({el:$(document)});this.nav.model.set({user:decide.user,isNativeScroll:true});Backbone.Router.prototype.constructor.apply(this,arguments);$("html").addClass("loaded");var routeData={viewName:$("body").attr("data-view")};decide.eventBus.trigger("route",routeData);decide.eventBus.trigger("route:"+routeData.viewName,routeData)}});ns("decide").ApplicationView=Backbone.View.extend({constructor:function(){_.extend(this,decide.ApplicationBase,decide.formatters.get());_.bindAll(this);Backbone.View.prototype.constructor.apply(this,arguments)},hide:function(){this.$el.hide();this.isVisible=false;this.trigger("hide");$(document).trigger("hide",this);return this},show:function(){this.$el.show();this.isVisible=true;this.trigger("show");$(document).trigger("show",this);return this},toggle:function(shouldShow){return this.toggleVisibility(shouldShow)},toggleVisibility:function(shouldShow){(shouldShow?this.show:this.hide)()},views:{},addView:function(keyOrObj,instance){var _addView=_.bind(function(instance,key){this.views[key]=instance.on("route",function(params,replace){this.trigger("route",params,replace)},this)},this);if(_.isObject(keyOrObj)){_.each(keyOrObj,_addView)}else{_addView(instance,keyOrObj)}return this},addViews:function(){return this.addView.apply(this,arguments)},mustache:function(model,template){if(template===undefined){template=this.template}if(model===undefined){model=this.model&&this.model.toJSON()}if(_.isFunction(template)){return template(_.extend(decide.core.renderContext.get(),model))}},render:function(){this.$el.html(this.mustache(this.model&&this.model.toJSON()));return this},hasContent:function(){return(this.$el.contents().length>0)},loadTemplate:function(name){console.warn("tmpl is deprecated")},tmpl:function(name){console.warn("tmpl is deprecated")},setTmpl:function(name){this.template=this.tmpl(name);return this}});ns("decide").ApplicationPage=decide.ApplicationView.extend({constructor:function(){if(this.name.length){console.log("Initializing "+this.name+" page");this.setTmpl(this.name+"Page").title=decide.message.formatter.format("pageTitle."+this.name)}decide.ApplicationView.prototype.constructor.apply(this,arguments)},title:"Decide.com: Online Shopping for TVs, Computers, Cameras, Appliances & Electronics",loadingTitle:"Loading... | Decide.com",name:"",hide:function(){this._scrollTop=$(window).scrollTop();console.log("You might want to implement ApplicationPage hide",this);return this},show:function(){if(decide.history&&decide.history.routeChanges.length>=1){this._scrollTop=this._scrollTop||0;console.log("Scrolling to",this._scrollTop);window.scrollTo(0,this._scrollTop)}this.resetScrollSections();return this},resetScrollSections:function resetScrollSections(){},resetScrollTop:function(){this._scrollTop=0},isPage:function(name){return $("body").hasClass(name+"_page")},pageContainer:function(html){return'<div class="page_content">'+(html||"")+"</div>"},updateTitle:function(){if(this.title.indexOf("{")>=0&&this.model){if(this.model.isLoaded||!this.model.isLoading){this.setTemplatedTitle()}else{this.setTitle(this.loadingTitle);this.model.on("sync:complete",_.once(this.setTemplatedTitle))}}else{this.setTitle(this.title)}return this},setTitle:function(t){console.log("Set document.title",t);document.title=t;return this},setTemplatedTitle:function(){return this.setTitle($.mustache(this.title,this.model.toJSON()))}});ns("decide").SignUpView=decide.ApplicationPage.extend({initialize:function(){this.model.on("attemptedEmail",this.updateEmail).on("sync:start",this.syncStart).on("sync:success",this.syncSuccess);this.currentlySubmitting=false;this.flashMessages=new decide.collections.FlashMessageCollection();this.flashMessageTemplate=this.loadTemplate("flashMessages");this.flashMessages.on("add",this.renderFlash).on("remove",this.renderFlash).on("reset",this.renderFlash)},destroy:function(){this.model.off("attemptedEmail",this.updateEmail,this).off("sync:start",this.syncStart,this).off("sync:success",this.syncSuccess,this);this.flashMessages.off("add",this.renderFlash,this).off("remove",this.renderFlash,this).off("reset",this.renderFlash,this);this.undelegateEvents()},renderFlash:function(){this.$(".alert.container").removeClass("container").find("a.close").remove()},syncStart:function(){this.flashMessages.reset().flashInfo('<img src="/img/loading.gif"/>Signing up...')},syncSuccess:function(){this.currentlySubmitting=false},getEmail:function(signupMethod){return signupMethod==="facebook"?(this.model.facebookDetails&&this.model.facebookDetails.email):(this.$(".email_signup input[name=email]").val())},getPassword:function(signupMethod){return signupMethod==="facebook"?(this.$('.facebook_signup input[name="password"]').val()):(this.$(".email_signup input[name=password]").val())},resetErrors:function(){this.flashMessages.reset()},show:function(){return decide.ApplicationPage.prototype.show.call(this)},facebookSignUp:function(){if(!this.currentlySubmitting){this.currentlySubmitting=true;decide.signupState.set("signupMethod","facebook");return this.signUp("facebook")}else{return false}},updateEmail:function(email){this.$(".email_section input[name=email]").val(email)},signUp:function(signupMethod,optionalParams){this.resetErrors();var email=this.getEmail(signupMethod);var password=this.getPassword(signupMethod);var validationErrorKey=this.getErrorKey(email,password);if(validationErrorKey){this.error(validationErrorKey);return false}if(this.model.facebookDetails){accessToken=this.model.facebookDetails.accessToken;userId=this.model.facebookDetails.userId}else{accessToken=null;userId=null}if(signupMethod==="facebook"&&accessToken&&userId){this.$("form input[name=id]").val(userId);this.$("form input[name=access_token]").val(accessToken);this.$("form input[name=email]").val(email)}this.$("form").submit();return false},getErrorKey:function(email,password){if(!_.isEmpty(email)&&!email.match(this.model.EMAIL_REGEX)){return"Please enter a valid email address"}else{if(!_.isEmpty(password)&&password.length<6){return"Password must be at least 6 characters."}else{if(_.isEmpty(email)){return"Please enter an email and password"}else{return null}}}},success:function(){var eventData=this.generateEvent(true);console.log("Successful sign up",eventData);this.resetErrors();this.model.pendingAction&&this.model.executePendingAction();decide.eventBus.trigger("signup",eventData);decide.eventBus.trigger("signup:success",eventData);$(document).trigger("signupComplete",decide.signupState.get("signupMethod"));this.currentlySubmitting=false},error:function(errorMessage){var eventData=this.generateEvent(false,errorMessage);console.log("Unsuccessful sign up",eventData);decide.eventBus.trigger("signup",eventData);decide.eventBus.trigger("signup:fail",eventData);this.flashMessages.reset().flashError(errorMessage);this.currentlySubmitting=false},generateEvent:function(isSuccess,errorMessage){var eventData={signupState:decide.signupState.toJSON(),summary:decide.signupState.toSummaryString()};if(isSuccess!==undefined){eventData.isSuccess=isSuccess}if(errorMessage!==undefined){eventData.errorMessage=errorMessage}return eventData},getFacebookDetails:function(){this.resetErrors();this.flashMessages.reset().flashInfo('<img src="/img/loading.gif"/>Connecting to Facebook...');FB.login(this.facebookLoginHandler,{scope:"email"});return false},facebookLoginHandler:function(response){if(response&&response.authResponse){var accessToken=response.authResponse.accessToken;if(accessToken){console.log("Logged into Facebook with access token: "+accessToken);var that=this;FB.api("/me",function(response){if(response.id&&response.email){console.log("Retrieved from Facebook id: "+response.id+", email: "+response.email);that.model.updateFacebookDetails({accessToken:accessToken,userId:response.id,email:response.email,name:response.name});that.facebookSignUp()}else{that.error("Unable to get id and email from this Facebook response")}})}else{this.error("Unable to get access token from this Facebook response")}}else{this.error("Facebook login canceled")}return false}});ns("decide").LoginView=decide.ApplicationPage.extend({initialize:function(){this.model.on("sync:start",this.syncStart).on("sync:success",this.syncSuccess);this.flashMessages=new decide.collections.FlashMessageCollection();this.flashMessageTemplate=this.loadTemplate("flashMessages");this.flashMessages.on("add",this.renderFlash).on("remove",this.renderFlash).on("reset",this.renderFlash)},destroy:function(){this.model.off("sync:start",this.syncStart).off("sync:success",this.syncSuccess);this.flashMessages.off("add",this.renderFlash).off("remove",this.renderFlash).off("reset",this.renderFlash);this.undelegateEvents()},renderFlash:function(){this.$(".alert.container").removeClass("container").find("a.close").remove()},syncStart:function(){this.flashMessages.reset().flashInfo('<img src="/img/loading.gif"/>Logging in...')},syncSuccess:function(){},showFacebook:function(){if(typeof(FB)!=="undefined"){this.$(".facebook_section").show()}return this},show:function(){this.showFacebook();decide.ApplicationPage.prototype.show.call(this)},resetErrors:function resetErrors(){this.flashMessages.reset();this.model.updateAttemptedEmail(null);this.model.attemptedAccessToken=null},getErrorKey:function(email,password){if(!_.isEmpty(email)&&!email.match(this.model.EMAIL_REGEX)){return"ui.login.invalidEmail"}else{if(_.isEmpty(email)){return"ui.login.incompleteCredentials"}else{return null}}},loginWithFacebook:function loginWithFacebook(){this.resetErrors();this.flashMessages.reset().flashInfo('<img src="/img/loading.gif"/>Connecting to Facebook...');FB.login(this.facebookLoginHandler,{scope:"email"});return false},facebookLoginHandler:function(response){if(response&&response.authResponse){var accessToken=response.authResponse.accessToken;if(accessToken){console.log("Logged into Facebook with access token: "+accessToken);FB.api("/me",_.bind(function(response){if(response.id&&response.email){console.log("Retrieved from Facebook id: "+response.id+", email: "+response.email);this.$("form").find("input[name=access_token]").val(accessToken).end().find("input[name=email]").val(response.email).end().find("input[name=password]").val("").end().submit()}else{this.error("Unable to get id and email from this Facebook response")}},this))}else{console.log("Unable to get access token from this Facebook response: "+JSON.stringify(response));this.error("Error connecting to Facebook, please try again later")}}else{this.error("Facebook login canceled")}},success:function(){this.resetErrors();this.model.pendingAction&&this.model.executePendingAction();decide.eventBus.trigger("login:success")},error:function(errorMsg){decide.eventBus.trigger("login:fail");this.flashMessages.reset().flashError(errorMsg)},errorLogin:function(errorState){this.error(errorState?"Invalid email or password, please try again":"Something went wrong. We are looking into it. Please try again later.")},errorFacebook:function(errorState){this.error(errorState?"Your Facebook account is not linked to Decide, please sign up below.":"Something went wrong. We are looking into it. Please try again later.")},prepareSignUp:function prepareSignUp(){this.model.updateFacebookDetails({});this.updateAttemptedEmail()},updateAttemptedEmail:function updateAttemptedEmail(){email=this.$("input[name=email]").val();this.model.updateAttemptedEmail(email)}});ns("decide").ApplicationModel=Backbone.Model.extend({pjax:false,constructor:function(){_.extend(this,decide.ApplicationBase,decide.formatters.get());this.isLoaded=this.isLoading=false;Backbone.Model.prototype.constructor.apply(this,arguments);this.url&&(this.url=_.wrap(this.url,function(url){_.isFunction(url)&&(url=url());return url+((url.indexOf("?")>-1)?"&":"?")+"v="+decide.applicationVersion}));_.bindAll(this,"isAttrEqualToDefault")},tmpl:function(name){console.warn("tmpl is deprecated")},sync:function(method,model,options){this.trigger("sync:start",method,model,undefined,options);this.isLoading=true;options=options||{};var success=options.success;var error=options.error;var complete=function(status){model.trigger("sync:complete",method,model,status)};var modifiedOpts=_.extend(options,{success:function(resp,status,xhr){model.isLoading=false;model.isLoaded=true;if(resp.userEmailAddress&&resp.userEmailAddress!==""){decide.user.set({emailAddress:resp.userEmailAddress})}if(success){success(resp,status,xhr)}model.trigger("sync:success",method,model,status);complete(status)},error:function(resp,status,xhr){model.isLoading=false;console.warn("Error syncing model",model.toString(),method,model);if(error){error(resp,status,xhr)}model.trigger("sync:error",method,model,status);complete(status)}});Backbone.sync.call(this,method,model,modifiedOpts)},isAttrEqualToDefault:function(key){var defaults=_.isFunction(this.defaults)?this.defaults():this.defaults;return _.isEqual(this.get(key),defaults[key])},diff:function(attrs){return _.reject(attrs,function(v,k){return(this.get(k)==v)},this)},objToQueryString:function(obj,prefix){if(_.isUndefined(prefix)){prefix=""}var mapper=function(val,key){if(_.isArray(val)){return _.map(val,function(v){return mapper.call(this,v,key)})}else{if(_.isObject(val)){return _.map(val,function(v,k){return mapper.call(this,v,key+"."+k)})}else{val=decodeURIComponent(val);return(prefix+key+"="+encodeURIComponent(val))}}};return _.chain(obj).map(mapper).flatten().value().join("&")}});ns("decide").ApplicationCollection=Backbone.Collection.extend({constructor:function(){_.extend(this,decide.ApplicationBase);Backbone.Collection.prototype.constructor.apply(this,arguments)}});ns("decide.views").EventBus=Backbone.View.extend({});ns("decide.models").PageInfo=Backbone.Model.extend({find:function(key){var methods={view:function(){return $("body").data("view")},searchCategoryName:function(){return $(".product_tile").data("categoryName")},productCategoryName:function(){return $("section#product_info").data("categoryName")},productDecideScore:function(){var $productInfo=$(".product_page #product_info");var score=$productInfo.find(".score .value").text()||"no score";return score}};var method=methods[key];return _.isUndefined(method)?null:method()}});var Mustache=function(){var _toString=Object.prototype.toString;Array.isArray=Array.isArray||function(obj){return _toString.call(obj)=="[object Array]"};var _trim=String.prototype.trim,trim;if(_trim){trim=function(text){return text==null?"":_trim.call(text)}}else{var trimLeft,trimRight;if((/\S/).test("\xA0")){trimLeft=/^[\s\xA0]+/;trimRight=/[\s\xA0]+$/}else{trimLeft=/^\s+/;trimRight=/\s+$/}trim=function(text){return text==null?"":text.toString().replace(trimLeft,"").replace(trimRight,"")}}var escapeMap={"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"};function escapeHTML(string){return String(string).replace(/&(?!#?\w+;)|[<>"']/g,function(s){return escapeMap[s]||s})}var regexCache={};var Renderer=function(){};Renderer.prototype={otag:"{{",ctag:"}}",pragmas:{},buffer:[],pragmas_implemented:{"IMPLICIT-ITERATOR":true},context:{},render:function(template,context,partials,in_recursion){if(!in_recursion){this.context=context;this.buffer=[]}if(!this.includes("",template)){if(in_recursion){return template}else{this.send(template);return}}template=this.render_pragmas(template);var html=this.render_section(template,context,partials);if(html===false){html=this.render_tags(template,context,partials,in_recursion)}if(in_recursion){return html}else{this.sendLines(html)}},send:function(line){if(line!==""){this.buffer.push(line)}},sendLines:function(text){if(text){var lines=text.split("\n");for(var i=0;i<lines.length;i++){this.send(lines[i])}}},render_pragmas:function(template){if(!this.includes("%",template)){return template}var that=this;var regex=this.getCachedRegex("render_pragmas",function(otag,ctag){return new RegExp(otag+"%([\\w-]+) ?([\\w]+=[\\w]+)?"+ctag,"g")});return template.replace(regex,function(match,pragma,options){if(!that.pragmas_implemented[pragma]){throw ({message:"This implementation of mustache doesn't understand the '"+pragma+"' pragma"})}that.pragmas[pragma]={};if(options){var opts=options.split("=");that.pragmas[pragma][opts[0]]=opts[1]}return""})},render_partial:function(name,context,partials){name=trim(name);if(!partials||partials[name]===undefined){throw ({message:"unknown_partial '"+name+"'"})}if(!context||typeof context[name]!="object"){return this.render(partials[name],context,partials,true)}return this.render(partials[name],context[name],partials,true)},render_section:function(template,context,partials){if(!this.includes("#",template)&&!this.includes("^",template)){return false}var that=this;var regex=this.getCachedRegex("render_section",function(otag,ctag){return new RegExp("^([\\s\\S]*?)"+otag+"(\\^|\\#)\\s*(.+?)\\s*"+ctag+"\n*([\\s\\S]*?)"+otag+"\\/\\s*\\3\\s*"+ctag+"\\s*([\\s\\S]*)$","g")});return template.replace(regex,function(match,before,type,name,content,after){var renderedBefore=before?that.render_tags(before,context,partials,true):"",renderedAfter=after?that.render(after,context,partials,true):"",renderedContent,value=that.find(name,context);if(type==="^"){if(!value||Array.isArray(value)&&value.length===0){renderedContent=that.render(content,context,partials,true)}else{renderedContent=""}}else{if(type==="#"){if(Array.isArray(value)){renderedContent=that.map(value,function(row){return that.render(content,that.create_context(row),partials,true)}).join("")}else{if(that.is_object(value)){renderedContent=that.render(content,that.create_context(value),partials,true)}else{if(typeof value=="function"){renderedContent=value.call(context,content,function(text){return that.render(text,context,partials,true)})}else{if(value){renderedContent=that.render(content,context,partials,true)}else{renderedContent=""}}}}}}return renderedBefore+renderedContent+renderedAfter})},render_tags:function(template,context,partials,in_recursion){var that=this;var new_regex=function(){return that.getCachedRegex("render_tags",function(otag,ctag){return new RegExp(otag+"(=|!|>|&|\\{|%)?([^#\\^]+?)\\1?"+ctag+"+","g")})};var regex=new_regex();var tag_replace_callback=function(match,operator,name){switch(operator){case"!":return"";case"=":that.set_delimiters(name);regex=new_regex();return"";case">":return that.render_partial(name,context,partials);case"{":case"&":return that.find(name,context);default:return escapeHTML(that.find(name,context))}};var lines=template.split("\n");for(var i=0;i<lines.length;i++){lines[i]=lines[i].replace(regex,tag_replace_callback,this);if(!in_recursion){this.send(lines[i])}}if(in_recursion){return lines.join("\n")}},set_delimiters:function(delimiters){var dels=delimiters.split(" ");this.otag=this.escape_regex(dels[0]);this.ctag=this.escape_regex(dels[1])},escape_regex:function(text){if(!arguments.callee.sRE){var specials=["/",".","*","+","?","|","(",")","[","]","{","}","\\"];arguments.callee.sRE=new RegExp("(\\"+specials.join("|\\")+")","g")}return text.replace(arguments.callee.sRE,"\\$1")},find:function(name,context){name=trim(name);function is_kinda_truthy(bool){return bool===false||bool===0||bool}var value;if(name.match(/([a-z_]+)\./ig)){var childValue=this.walk_context(name,context);if(is_kinda_truthy(childValue)){value=childValue}}else{if(is_kinda_truthy(context[name])){value=context[name]}else{if(is_kinda_truthy(this.context[name])){value=this.context[name]}}}if(typeof value=="function"){return value.apply(context)}if(value!==undefined){return value}return""},walk_context:function(name,context){var path=name.split(".");var value_context=(context[path[0]]!=undefined)?context:this.context;var value=value_context[path.shift()];while(value!=undefined&&path.length>0){value_context=value;value=value[path.shift()]}if(typeof value=="function"){return value.apply(value_context)}return value},includes:function(needle,haystack){return haystack.indexOf(this.otag+needle)!=-1},create_context:function(_context){if(this.is_object(_context)){return _context}else{var iterator=".";if(this.pragmas["IMPLICIT-ITERATOR"]){iterator=this.pragmas["IMPLICIT-ITERATOR"].iterator}var ctx={};ctx[iterator]=_context;return ctx}},is_object:function(a){return a&&typeof a=="object"},map:function(array,fn){if(typeof array.map=="function"){return array.map(fn)}else{var r=[];var l=array.length;for(var i=0;i<l;i++){r.push(fn(array[i]))}return r}},getCachedRegex:function(name,generator){var byOtag=regexCache[this.otag];if(!byOtag){byOtag=regexCache[this.otag]={}}var byCtag=byOtag[this.ctag];if(!byCtag){byCtag=byOtag[this.ctag]={}}var regex=byCtag[name];if(!regex){regex=byCtag[name]=generator(this.otag,this.ctag)}return regex}};var r=function(template,view,partials,send_fun){var renderer=new Renderer();if(send_fun){renderer.send=send_fun}renderer.render(template,view||{},partials);if(!send_fun){return renderer.buffer.join("\n")}};return({name:"mustache.js",version:"0.4.2",to_html:r,render:r})}();(function($){$.mustache=function(template,view,partials){return Mustache.to_html(template,view,partials)}})(jQuery);ns("decide.views").ForgotPassword=decide.ApplicationPage.extend({name:"forgotPassword",initialize:function initialize(options){_.bindAll(this,"render","updateEmail","submit");this.model.bind("attemptedEmail",this.updateEmail);this.render()},events:{"submit form#forgot_password":"submit"},show:function show(){this.$(".forgotPassword").show();this.$(".successMessage").hide();return decide.ApplicationPage.prototype.show.call(this)},hide:function hide(){},updateEmail:function updateEmail(email){this.$("input[name=email]").val(email)},submit:function submit(e){var email=this.$("input[name=email]").val();if(!this.validateEmail(email)){return false}var that=this;this.model.forgotPassword(email,function(){that.$(".forgotPassword").hide();that.$(".successMessage").show()});return false},validateEmail:function validateEmail(email){var error=null;if(_.isEmpty(email)||!email.match(this.model.EMAIL_REGEX)){error="ui.login.invalidEmail"}if(error){$("#forgot_password_error").text(this.format(error).toString()).show();return false}return true}});ns("decide.views").LoginPage=decide.LoginView.extend({name:"login",initialize:function(){_.bindAll(this);decide.LoginView.prototype.initialize.call(this);$(document).on("facebook:ready",this.showFacebook);this.render()},events:{"click .facebook_login":"loginWithFacebook","click a[data-view=sign_up]":"prepareSignUp","click a[data-view=forgot_password]":"updateAttemptedEmail"},success:function(){decide.LoginView.prototype.success.call(this);if(this.model.pendingAction){this.model.executePendingAction()}else{this.trigger("route",{url:"/account/alerts"},true)}}});ns("decide.views").SettingsPage=decide.ApplicationPage.extend({initialize:function(){_.bindAll(this);this.$notice=this.$(".form-actions .notice");this.$form=this.$("form");this.$form.on({"ajax:complete":this.complete,"ajax:before":this.before}).find("input").on("change",this.inputChange)},before:function(){this.$notice.removeClass("visible")},complete:function(e,st){this.$notice.addClass("visible")},inputChange:function(){this.$form.submit()}});ns("decide.views").SignUpPage=decide.SignUpView.extend({name:"signUp",initialize:function(){_.bindAll(this);decide.SignUpView.prototype.initialize.call(this)},events:{"click .facebook_login":"getFacebookDetails"},success:function(){decide.SignUpView.prototype.success.call(this);if(this.model.pendingAction){this.model.executePendingAction()}else{window.location="/account/alerts"}}});ns("decide.views").UserNav=decide.ApplicationView.extend({initialize:function(){this.setTmpl("userNav");_.bindAll(this);$(document).on("showLogin",this.showLogin);$(document).on("showSignUp",this.showSignUp);$(document).on("click",".show_forgot_password",this.showForgotPassword);$(document).on("click","#track_link, .alert_button",this.setAlert);this.render()},events:{"click #user_link":"toggleUser","mouseover #user_email":"userEmailHover","mouseout #user_email":"userEmailHover","touchstart #user_email":"userEmailHover","click #user_nav_dropdown a":"userClickAction","click .login a":"prevent","click .signup a":"prevent"},prevent:function(e){e.preventDefault()},createUserView:function(gybMode){return new decide.views.User({model:this.model,gybMode:gybMode})},startLightbox:function(initialUserView,gybMode){var lightbox=this.views.lightbox;if(lightbox&&lightbox.isVisible()){lightbox.closeLightbox()}this.addView("lightbox",new decide.views.Lightbox({gybMode:gybMode}).render(initialUserView))},showUserNav:function(){$(document.body).addClass("hovering");$("#user_nav_dropdown").addClass("showing")},hideUserNav:function(){$(document.body).removeClass("hovering");$("#user_nav_dropdown").removeClass("showing")},userClickAction:function(){this.userEmailHover({type:"mouseout"},true)},userEmailHover:function(e,immediately){if($("html").is(".ie7")){return}if(typeof(immediately)==="undefined"){immediately=false}if(e.type==="mouseover"||e.type=="touchstart"){clearTimeout(this.showAllTimeout);this.showAllTimeout=setTimeout(this.showUserNav,immediately?10:200);clearTimeout(this.hideAllTimeout)}else{clearTimeout(this.showAllTimeout);this.hideAllTimeout=setTimeout(this.hideUserNav,immediately?10:300)}},documentClick:function(e){var $target=$(e.target);if(!$target.is("#user_links")&&!($target.parents("#user_links").length)&&!$target.is("#user_link")&&!$target.is(".user")){this.$("#user_links").hide();$(document).unbind("mousedown",this.documentClick)}},signOut:function signOut(e){decide.ga.trackEvent("login","logout");var that=this;var logoutDone=function(){decide.user.setLoggedOut();that.hideUserNav();decide.eventBus.trigger("logout");if(location.href.indexOf("/account")>-1||location.href.indexOf("/deals")>-1){console.log("Logged out, leaving the account page");window.location="/"}else{location.reload()}};this.model.logout(logoutDone,logoutDone);e.preventDefault()},toggleUser:function(){var $userNav=this.$("#user_links");$userNav.toggle();if($userNav.is(":visible")){$(document).bind("mousedown",this.documentClick)}},addToAlertCount:function(x){var $alertCount=this.$el.find("#alert_count a");$alertCount.text(parseInt($alertCount.text(),10)+x).stop(true).css({backgroundColor:"#FF0000"}).delay(2000).animate({backgroundColor:"#666666"},1200)},setAlert:function(e){var $el=$(e.currentTarget),productId=$el.data("id");var shouldToggle=true;if($el.hasClass("alert_set")){this.addToAlertCount(-1)}else{if(this.model.isUserLoggedIn()){this.addToAlertCount(1)}else{e.preventDefault();decide.signupState.set("signupSource","product_alert");decide.eventBus.trigger("login:required",{productId:productId});shouldToggle=false}}if(shouldToggle){$el.toggleClass("alert_set").toggleClass("set_alert");$el.addClass("disabled")}},showLogin:function(e){var gybMode=($("body").data("view")==="deals");this.startLightbox(this.createUserView(gybMode).showLogin(),gybMode);e.preventDefault()},showSignUp:function(e){var gybMode=($("body").data("view")==="deals");this.startLightbox(this.createUserView(gybMode).showSignup(),gybMode);e.preventDefault()},showForgotPassword:function(e){this.model.forgotPassword(this.model.get("emailAddress"),this._forgotPasswordSuccessHandler,this._forgotPasswordErrorHandler);e.preventDefault()},_forgotPasswordSuccessHandler:function(){decide.flashMessages.flashSuccess(this.format("ui.forgotPassword.success"),4000)},_forgotPasswordErrorHandler:function(){decide.flashMessages.flashError(this.format("ui.forgotPassword.error"))},render:function(){if(!this.hasContent()){var emailAddress=this.model.get("emailAddress")||"";this.$el.html(this.mustache({emailAddress:emailAddress,isLoggedIn:!_.isEmpty(emailAddress),alertCount:this.model.get("alertCount")}));this.$("li.upgrade > a").attr("href","/member?returnUrl="+encodeURIComponent(window.location.pathname+window.location.search))}}});ns("decide.models").FlashMessage=decide.ApplicationModel.extend({defaults:{closable:false},toJSON:function(){var obj={};for(k in this.attributes){obj[k]=this.attributes[k]}return _.extend(obj,{id:this.getCid()})},getCid:function(){return"flash_message_"+this.cid}});ns("decide.collections").FlashMessageCollection=decide.ApplicationCollection.extend({model:decide.models.FlashMessage,types:{Success:{name:"SUCCESS",cssClass:"alert alert-success"},Error:{name:"ERROR",cssClass:"alert alert-error"},Info:{name:"INFO",cssClass:"alert alert-info"},Default:{name:"DEFAULT",cssClass:"alert"}},initialize:function(){_.bindAll(this);_(this.types).each(function(val,key){this["flash"+key]=this.bindFlashFn(val)},this)},toJSON:function(){return{flashMessages:this.map(function(m){return m.toJSON()})}},flash:function(message,type,timeout){var m=new decide.models.FlashMessage({message:message,type:type||this.types.DEFAULT});this.add(m);if(timeout){window.setTimeout(this.bindTimeoutFn(m),timeout)}},bindFlashFn:function(type){return _.bind(function(message,timeout){this.flash(message,type,timeout)},this)},bindTimeoutFn:function(model){return _.bind(function(model){this.trigger("flash:expire",model)},this,model)},getTypeByName:function(type){return _(this.types).find(function(v,k){return v.name===type})||this.types.Default}});ns("decide.models").LocalOffers=decide.ApplicationModel.extend({initialize:function(){this.isFullyLoaded=false;_.bindAll(this,"url")},defaults:{offers:new Backbone.Collection(),sort:"BASE_WITH_TAX",isMobile:true},url:function(){var common={};var url=$.mustache("/local/{{id}}/search.json?sort={{sort}}",{id:this.get("id"),sort:this.get("sort")});if(typeof(PhoneGap)!=="undefined"){url=(py.ENDPOINT||"http://www.decide.com")+url}if(py.geoloc&&py.geoloc.loaded&&py.geoloc.position){url+=$.mustache("&lat={{lat}}&lng={{lng}}",{lat:py.geoloc.position.coords.latitude,lng:py.geoloc.position.coords.longitude})}else{if(this.get("shippingAndTaxPostalCode")){url+=$.mustache("&pc={{postalCode}}",{postalCode:this.get("shippingAndTaxPostalCode")})}else{console.warn("Warning: Trying to get local data without location data. Oh no you didn't.")}}return url},priceButtonMap:function(){var map={canonicalUrl:this.get("canonicalUrl"),basePriceString:"Nearby Prices",totalPriceString:"Unavailable",buttonClass:"disabled",column:"column2",subpage:"local-prices",gaLabel:"compare-prices-local",isBuy:true};if(this.isFullyLoaded){var llo=this.lowestLocalOffer,basePrice=llo.get("price"),totalPrice=llo.get("totalPrice");var basePriceString=(basePrice<1)?this.formatNumber.priceCentsOnly.format(basePrice):this.formatNumber.priceNoCents.format(basePrice);var totalPriceString=(totalPrice<1)?this.formatNumber.priceCentsOnly.format(totalPrice):this.formatNumber.priceNoCents.format(totalPrice);_.extend(map,{basePriceString:this.format("mobile.product.price.nearby","",[basePriceString]),totalPriceString:this.format("mobile.product.price.withTax","",[totalPriceString]),buttonClass:"neutral"})}return map},parse:function(resp){this.isFullyLoaded=true;if(resp.localProductAvailabilityInfo){var offers=_.map(resp.localProductAvailabilityInfo.availabilities,function(a,i){var totalPrice=a.priceWithTax||a.price;var priceString=this.formatNumber.priceCents.format(a.price);var totalPriceString=this.formatNumber.priceCents.format(totalPrice);if(a.price<1){priceString=this.formatNumber.priceCentsOnly.format(a.price)}if(totalPrice<1){totalPriceString=this.formatNumber.priceCentsOnly.format(totalPrice)}totalPriceString=this.format("mobile.product.price.withTax","",[totalPriceString]);var d=Math.round(a.distance*10)/10;var distance=this.formatPlural("unit.mile","",d);var address=a.address;var addressString=_.template("{{street}}, {{city}}, {{state}} {{postalCode}}",{street:address.streetName,city:address.localityName,state:address.principalSubdivision.code,postalCode:address.postalCode});var prettyPhone=a.phoneNumber;if(prettyPhone.length>=10){prettyPhone=_.template("({{area}}) {{prefix}}-{{suffix}}",{area:prettyPhone.substr(0,3),prefix:prettyPhone.substr(3,3),suffix:prettyPhone.substr(6,4)})}var localOffer=_.extend(a,{price:a.price,priceString:priceString,totalPrice:totalPrice,totalPriceString:totalPriceString,showPrice:(a.availability!=="UNKNOWN"),sellerName:a.locationName,distance:distance,availabilityDescription:this.format("local.availability."+a.availability),addressString:addressString,addressStringUrlEncoded:encodeURIComponent(addressString),id:_.uniqueId(),prettyPhone:prettyPhone,letter:String.fromCharCode(65+i)});localOffer.availabilityClass=localOffer.availability.toLowerCase().replace(/\s/g,"_");return localOffer},this);this.get("offers").reset(offers);this.lowestLocalOffer=this.get("offers").find(function(offer){return(offer.get("availability")!=="UNKNOWN")});this.change()}},hasOffers:function(){var offers=this.get("offers");return(offers&&offers.length>0&&this.lowestLocalOffer)},priceInfo:function(){var totalOffers=this.get("offers").size(),isSRP=$("body").is(".search_page");return this.lowestLocalOffer?{priceType:"nearby",hashUrl:"nearby",lowestPrice:this.formatNumber.priceCents.format(this.lowestLocalOffer.get("price")),totalOffers:totalOffers,allStores:this.formatPlural("allStores","",totalOffers),canonicalUrl:this.canonicalUrl(),isSRP:isSRP,dropoffTarget:"_self",dropoffUrl:this.canonicalUrl()+"/nearby",prices:this.get("offers").chain().first(5).map(function(o){return{seller:o.get("locationName"),sellerInfo:o.get("distance"),price:this.formatNumber.priceCents.format(o.get("price")),dropoff:this.canonicalUrl()+"/nearby"}},this).value()}:{}},nearbySummary:function(){if(!this.hasOffers()){return null}var nearbySummary=null;if(this.lowestLocalOffer){nearbySummary=this.formatNumber.priceNoCents.format(Math.abs(this.lowestLocalOffer.get("totalPrice")))}else{nearbySummary=this.formatPlural("productPane.store","",this.get("offers").length)}return nearbySummary},canonicalUrl:function(){return this.get("canonicalUrl")||"/p/"+this.id}});if(py&&py.Models){py.Models.LocalOffers=decide.models.LocalOffers}ns("decide.models").LogEntry=decide.ApplicationModel.extend({initialize:function(){_.bindAll(this)},url:function(){var params=_.clone(this.attributes);var logger=params.logger;delete params.logger;return decide.env.endpoint("/log/"+logger+"?"+$.param(params))}});ns("decide.models").Product=decide.ApplicationModel.extend({defaults:{shouldAlwaysFetchLocal:false},initialize:function(){this.isFullyLoaded=false;this._useBackupImage=false;this._loadQueue=[];this.title="";this.localOffers=new decide.models.LocalOffers({id:this.get("id"),mobile:false});_.bindAll(this,"useBackupImage","syncSuccess","getLocalOffers","url");this.on("sync:success",this.syncSuccess).on("sync:error",this.syncError)},whenLoaded:function(callbackFn){if(this.isFullyLoaded){callbackFn(this)}else{this._loadQueue.push(callbackFn)}},url:function(){var latLong="";if(decide.env.hasLocation()){var latLongTemplate="&lat={{lat}}&lng={{lng}}";var lat=py.geoloc.position.coords.latitude;var lng=py.geoloc.position.coords.longitude;latLong=$.mustache(latLongTemplate,{lat:lat,lng:lng})}var path="/p/"+this.get("id")+"?src=xhr"+latLong;return decide.env.endpoint(path)},syncSuccess:function syncSuccess(){this.isFullyLoaded=true;_(this._loadQueue).each(function(callbackFn){callbackFn(this)},this);this.getLocalOffers()},syncError:function syncError(){document.locationin="/500.html"},getLocalOffers:function(){if(!this.localOffers.isFullyLoaded){var srslyGetEm=_.bind(function(){var os=this.get("offerSummary");this.localOffers.set({shippingAndTaxPostalCode:(os)?os.shippingAndTaxPostalCode:null,canonicalUrl:this.get("canonicalUrl")}).fetch()},this);if(py&&py.geoloc){py.geoloc.getPosition(srslyGetEm)}else{srslyGetEm()}}},parse:function(resp){if(resp.product==null){resp.product={}}return _.extend(resp.product,{canonicalUrl:resp.canonicalUrl,alertSet:resp.alertSet,productData:resp.productData,title:resp.productData.productInfoMap.title})},dropoffUrl:function(offer){if(!offer){return""}var seller=offer.seller;return this.format("product.dropoffLink","#",[this.id,seller.channelId,seller.channelOfferId,seller.id,seller.sellerProductId])},lowestPrice:function(){var lpo=this.lowestPriceOffer();return lpo?(this.formatNumber.priceSmartCents(lpo.amount)):""},lowestPriceOffer:function(){var os=this.get("offerSummary");return os?os.offers[os.lowestPriceOfferIndex]:null},lowestTotalPrice:function(){var lpo=this.lowestPriceOffer();return lpo?(this.formatNumber.priceSmartCents(lpo.totalPrice)):""},soldByHtml:function(){var os=this.get("offerSummary");if(os&&!_.isEmpty(os.offers)){var lpo=this.lowestPriceOffer();var totalOffers=this.get("offerSummary").offers.length;var sellerText=this.formatPlural("sellerText","",totalOffers);return this.formatPluralWithArgs("product.soldBy","",totalOffers,[this.dropoffUrl(lpo),lpo.seller.name,this.pageUrl()+"#compare_prices",sellerText])}else{return""}},pageUrl:function(){return"/p/"+this.id},getCachedImageUrl:function getCachedImageUrl(displaySize){return this._getImageUrlFromProductId(this.id,displaySize)},_getImageUrlFromProductId:function getImageUrlFromProductId(productId,displaySize){var template=this.tmpl("productImageUrl");if(window.devicePixelRatio&&window.devicePixelRatio>=2){displaySize=displaySize*2}if(displaySize<=80){displaySize=80}else{if(displaySize<=100){displaySize=100}else{if(displaySize<=140){displaySize=140}else{if(displaySize<=160){displaySize=160}else{if(displaySize<=200){displaySize=200}else{if(displaySize<=312){displaySize=312}else{displaySize=null}}}}}}return(displaySize!=null)?template({productId:productId,size:displaySize}):(this.tmpl("productImageUrlOriginal")({productId:productId}))},_buildMessageKey:function _buildMessageKey(messageType){return(messageType==="priceMessaging")?py.helpers.buildRecommendationKey(this.attributes,"PRICE"):py.helpers.buildRecommendationKey(this.attributes,"MODEL")},useBackupImage:function useBackupImage(){this._useBackupImage=true},title:function(){return this.get("title")},getRecommendationData:function(){var productData=this.get("productData");return productData&&productData.recommendationData},getModelPredictionData:function(){var recommendationData=this.getRecommendationData();return recommendationData&&recommendationData.modelPredictionData},getRumorPredictionData:function(){var recommendationData=this.getRecommendationData();return recommendationData&&recommendationData.rumorPredictionData},getPricePredictionData:function(){var recommendationData=this.getRecommendationData();return recommendationData&&recommendationData.pricePredictionData}});ns("decide.collections").ProductCollection=decide.ApplicationCollection.extend({model:decide.models.Product});ns("decide.models").SignupState=decide.ApplicationModel.extend({defaults:{signupSource:"static",signupMethod:"email"},toSummaryString:function(){var isMobile=decide.env.isMobile();var view=decide.pageInfo.find("view");var cameFrom="";switch(this.get("signupSource")){case"mikes_message":case"product_alert":break;case"header":case"banner":case"modal_prompt":case"static":default:cameFrom=view;break}var summary=(isMobile?"mobile ":"");summary+=this.get("signupSource");if(cameFrom&&cameFrom.length){summary+=" "+cameFrom}return summary}});ns("decide.models").User=decide.ApplicationModel.extend({defaults:{products:new decide.collections.ProductCollection(),alertCount:0},initialize:function(){decide.user=this;this.userKey="";_.bindAll(this);Backbone.emulateJSON=true;this.actions={create:{url:"/account/create"},read:{url:"/account"},update:{url:"/account/settings",method:"create"},addProductAlert:{url:"/account/alerts/{{id}}/add"},deleteProductAlert:{url:"/account/productAlerts/{{id}}/remove"},checkUpgrade:{url:"/signup/upgrade?email={{encodeURIComponent(email)}}"},checkUpgradeForFacebook:{url:"/signup/upgrade?accountSource=FACEBOOK&accessToken={{accessToken}}"},upgrade:{url:"/signup/upgrade",method:"create"},login:{url:"/login/submit",method:"create"},loginWithFacebook:{url:"/login/ext/FACEBOOK/{{accessToken}}"},forgotPassword:{url:"/login/password/submit?email={{encodeURIComponent(email)}}"},changePassword:{url:"/account/password",method:"create"},logout:{url:"/logout"}};this.EMAIL_REGEX=/^(([^<>()[\]\\.,;:\s@\"]+(\.[^<>()[\]\\.,;:\s@\"]+)*)|(\".+\"))@((\[[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\])|(([a-zA-Z\-0-9]+\.)+[a-zA-Z]{2,}))$/;this.percentFromDollars={25:"2.5",50:"5",100:"10"}},validate:function(attrs){if(attrs!==undefined&&"emailAddress" in attrs){var email=attrs.emailAddress;if(email&&!email.match(this.EMAIL_REGEX)){return{message:decide.message.formatter.format("invalidEmail").toString()}}}},urlForAction:function(action,urlParams){var action=this.actions[action];return decide.env.endpoint(action?_.template(action.url,_.extend(urlParams||{},{userKey:this.userKey})):"")},url:null,sync:function(method,model,success,error,urlParams,shouldPassAttributes){var data={};if(shouldPassAttributes===undefined){shouldPassAttributes=true}else{if(typeof(shouldPassAttributes)=="object"){data=shouldPassAttributes}}if(shouldPassAttributes===true){var attrNames=["emailAddress","productId"];_.each(attrNames,function(val){if(!_.isUndefined(this.attributes[val])){data[val]=this.attributes[val]}},this)}var url=this.urlForAction(method,urlParams);url+=((url.indexOf("?")>-1)?"&":"?")+"v="+decide.applicationVersion;var errorWrapper=_.bind(function(model,r,options){var errorKey="ui.unknownServiceError";if(_.isBoolean(r.errors)){errorKey=r.errors}else{if(_.isArray(r.errors)){var err=_.first(r.errors);err.defaultMessage&&(errorKey=err.defaultMessage)}}error&&error(errorKey)},this);var options={url:url,processData:true,data:data,success:_.bind(function(r,s,x){if(r&&r.errors){errorWrapper(this,r)}else{this.set(this.parse(r,x));success&&success(r,s,x)}},this),error:errorWrapper};var action=this.actions[method];var method=action&&action.method||"read";return decide.ApplicationModel.prototype.sync.call(this,method,this,options)},parse:function(response){var parsed={};console.log("Parsing response on User",response);if(!_.isEmpty(response.account)){parsed=response.account;if(parsed.hasOwnProperty("productAlerts")){parsed.productAlerts=_.sortBy(parsed.productAlerts,function(pa){return -pa.created})}}this.rawProductList=[];if("products" in response){this.rawProductList=response.products}parsed.alertCount=_.size(parsed.productAlerts);parsed.productData=response.productData;parsed.membershipFeatures=response.membershipPlan&&response.membershipPlan.features;if("userKey" in response){this.userKey=response.userKey}this.trigger("fetchSuccess");return parsed},fetch:function(options){var success=options&&options.success;var error=options&&options.error;return this.sync("read",this,success,error,false)},addProductAlert:function(productId){console.warn("I'm deprecated. Don't call me.");decide.eventBus.trigger("user:alert",{action:"set"});return this.sync("addProductAlert",this,null,null,{id:productId})},deleteProductAlert:function(productId){var pa=this.get("productAlerts");var paById=this.get("productAlertsById");this.set({productAlerts:_.reject(pa,function(pa){return(pa.productId==productId)},this),productAlertsById:_.reject(paById,function(id){return(id==productId)},this)},{silent:true});decide.eventBus.trigger("user:alert",{action:"unset"});return this.sync("deleteProductAlert",this,null,null,{id:productId},false)},update:function(attributes,success){return this.sync("update",this,success,null,null,attributes)},checkUpgrade:function checkUpgrade(email,accessToken,success,error){return email?this.sync("checkUpgrade",this,success,error,{email:email}):this.sync("checkUpgradeForFacebook",this,success,error,{accessToken:accessToken})},upgrade:function upgrade(email,password,accessToken,success,error){var params={password:password};if(email){params.email=email}else{params.accountSource="FACEBOOK";params.accessToken=accessToken}return this.sync("upgrade",this,success,error,null,params)},loginCallback:function(success){return _.bind(function(a,b,c){this.setLoggedIn();success(a,b,c)},this)},logoutCallback:function(success){return _.bind(function(a,b,c){this.setLoggedOut();if(success){success(a,b,c)}},this)},login:function login(email,password,success,error){return this.sync("login",this,this.loginCallback(success),error,null,{email:email,password:password})},loginWithFacebook:function loginWithFacebook(accessToken,email,success,error){return this.sync("loginWithFacebook",this,this.loginCallback(success),error,{accessToken:accessToken},{email:email})},signUpWithFacebook:function(email,password,accessToken,providerUserId,gyb,success,error,optionalParams){var params=_.extend({email:email,password:password,externalAccountSource:"FACEBOOK",accessToken:accessToken,providerUserId:providerUserId,gyb:gyb},optionalParams);this.set("signupMethod","facebook");return this._signUp(params,success,error)},forgotPassword:function forgotPassword(email,success,error){return this.sync("forgotPassword",this,success,error,{email:email})},changePassword:function(data,success,error){return this.sync("changePassword",this,success,error,{},data)},isUserLoggedIn:function isUserLoggedIn(){return !!this.get("emailAddress")},logout:function logout(success,error){this.attributes=_.extend({},this.defaults);this.sync("logout",this,this.logoutCallback(success),error)},setPendingAction:function setPendingAction(actionData){this.pendingAction=actionData},removePendingAction:function removePendingAction(){this.pendingAction=undefined},executePendingAction:function executePendingAction(){console.log("executing pending action");if(this.pendingAction){var action=this.pendingAction.action;switch(action.toLowerCase()){case"addproductalert":this.addProductAlert(this.pendingAction.productId);if(!action.silent){this.trigger("route",{view:"product",productId:this.pendingAction.productId},true)}break;case"route":if($.browser.msie){window.location=this.pendingAction.view}else{this.trigger("route",{view:this.pendingAction.view},false)}break;default:console.warn("Unknown pending action: "+JSON.stringify(this.pendingAction));break}}},updateAttemptedEmail:function updateAttemptedEmail(email){this.attemptedEmail=email;this.trigger("attemptedEmail",email)},updateFacebookDetails:function updateFacebookDetails(facebookDetails){this.facebookDetails=facebookDetails;this.trigger("facebookDetails",facebookDetails)},hasClosedBanner:function(){return(this.getSettings().hasClosedBanner===true)},hasClosedLightbox:function(){return(this.getSettings().hasClosedLightbox===true)},hasLoggedInCookie:function(){return(this.getSettings().loggedIn===true)},hasPrompted:function(){return(this.getSettings().hasPrompted===true)},getPromptedPage:function(){return this.getSettings().promptedPage||""},getPageViewCount:function(){return(parseInt(this.getSettings().pageViewCount)||0)},setHasClosedBanner:function(has){var settings=this.getSettings();settings.hasClosedBanner=has;decide.util.udc.setValue("settings",settings)},setHasClosedLightbox:function(has){var settings=this.getSettings();settings.hasClosedLightbox=has;decide.util.udc.setValue("settings",settings)},setLoggedIn:function(){var settings=this.getSettings();settings.loggedIn=true;decide.util.udc.setValue("settings",settings);if(this.has("membershipFeatures")){decide.membershipFeatures=_.reduce(this.get("membershipFeatures"),function(memo,feature){memo[feature]=true;return memo},{})}decide.core.renderContext.refresh()},setLoggedOut:function(){var settings=this.getSettings();settings.loggedIn=false;decide.util.udc.setValue("settings",settings);decide.membershipFeatures={};decide.core.renderContext.refresh()},setPrompted:function(){var settings=this.getSettings();settings.hasPrompted=true;settings.promptedPage=decide.pageInfo.find("view");decide.util.udc.setValue("settings",settings)},setPageViewCount:function(count){var settings=this.getSettings();settings.pageViewCount=parseInt(count)||0;decide.util.udc.setValue("settings",settings)},getSettings:function(){return decide.util.udc.getValue("settings")||{}}});ns("decide.views").BrowseMenu=decide.ApplicationView.extend({MENU_OPEN_DELAY_MS:300,MENU_CLOSE_DELAY_MS:200,initialize:function(){_.bindAll(this);this.showingNav=false;this.inTopMenu=false;this.inSubMenu=false;this.openMenuEvent=null;$("#header_wrapper .categories.horizontal li.all").hover(this.startHover,this.stopHover);$("#header_wrapper .categories.horizontal li.all").click(this.toggleAllCats);$(".all_categories").hover(this.startSubMenuHover,this.stopSubMenuHover);$(".all_categories").on("click","a",this.clickSubMenu)},startHover:function(e){e.preventDefault();e.stopPropagation();if(this.showingNav&&$(this.openMenuEvent.currentTarget).data("type")===$(e.currentTarget).data("type")){window.clearTimeout(this.stopHoverFunc);return}if(this.showingNav){$(e.currentTarget).click()}else{this.currentHoverFunc=window.setTimeout(_.bind(function(e){$(e.currentTarget).click()},this,e),this.MENU_OPEN_DELAY_MS)}},stopHover:function(e){if(this.showingNav){this.stopHoverFunc=window.setTimeout(_.bind(this.checkStop,this,e),this.MENU_CLOSE_DELAY_MS)}window.clearTimeout(this.currentHoverFunc);this.currentHoverEvent=null;this.currentHoverFunc=null},checkStop:function(e){if(!this.inSubMenu&&this.showingNav){$(e.currentTarget).click()}},startSubMenuHover:function(){this.inSubMenu=true},stopSubMenuHover:function(e){this.inSubMenu=false;var parentItem=$('ul.categories > li[data-type="'+$(e.currentTarget).data("type")+'"]');this.stopHoverFunc=window.setTimeout(_.bind(function(parentItem){if(this.showingNav){parentItem.click()}},this,parentItem),this.MENU_CLOSE_DELAY_MS)},clickSubMenu:function(e){if(this.openMenuEvent){$(this.openMenuEvent.currentTarget).click()}},toggleAllCats:function(e){if(this.isAnimating&&$(this.openMenuEvent.currentTarget).data("type")===$(e.currentTarget).data("type")){console.log("disregarding click");e.preventDefault();e.stopPropagation();return false}window.clearTimeout(this.stopHoverFunc);window.clearTimeout(this.currentHoverFunc);if(this.openMenuEvent&&$(this.openMenuEvent.currentTarget).data("type")===$(e.currentTarget).data("type")){this.showingNav=false;this.inSubMenu=false}else{if(this.openMenuEvent){this.showingNav=true;this.hideAllCats(this.openMenuEvent)}else{this.showingNav=true}}if(this.showingNav){this.showAllCats(e)}else{this.hideAllCats(e)}e.preventDefault();e.stopPropagation();return false},showAllCats:function(e){this.openMenuEvent=e;var type=$(e.currentTarget).data("type");$(".showing").removeClass("showing");if(!$(document.body).hasClass("loading")){var showQuery='[data-type="'+type+'"]';var topMenuQuery="li.all"+showQuery;var subMenuQuery=".all_categories"+showQuery;$(document.body).addClass("hovering");$(topMenuQuery).addClass("showing");$(subMenuQuery).show().addClass("showing")}if($("html").is(".ie")){$(".all_categories[data-type="+type+"]").show()}this.isAnimating=true;window.clearTimeout(this.animationFunc);this.animationFunc=window.setTimeout(_.bind(function(){this.isAnimating=false},this),400)},hideAllCats:function(e){this.openMenuEvent=null;var type=e?(_.isObject(e)&&(type=$(e.currentTarget).data("type"))):"";var hideQuery=".showing";if(type!==""){hideQuery+='[data-type="'+type+'"]'}$(hideQuery).removeClass("showing");if($(".showing").length<1){$(document.body).removeClass("hovering")}}});ns("decide.views").Dashboard=decide.ApplicationView.extend({mouseEnterTimeoutMS:300,mouseLeaveTimeoutMS:500,staticContext:{espresso:"http://espresso.decideit.org",sterling:"http://sterling.decideit.org",breve:"http://breve.decideit.org:10014",sports:"http://sports.decideit.org",realTimeCrawler:"http://dev2-sa002.decideit.org:10515",sumatra:"http://sumatra.decideit.org",hosts:["dev1","dev2","stage","test1","prod"]},initialize:function(){_.bindAll(this);this.lastEventedElement=null;this._currentEnterFunction=null;this._currentLeaveFunction=null;this.productTemplate=this.loadTemplate("dashboard_product");this.dropoffTemplate=this.loadTemplate("dashboard_dropoff");if(decide.features.dashboardPopovers){$(document).on(this.getProductEventMap(),"[data-upid]").on(this.getDropoffEventMap(),"a[data-sellername]").on(this.getPopoverEventMap(),"div.popover")}},getProductEventMap:function(){return{mouseenter:this.bindEntryFn("upid",this.renderProductTemplate),mouseleave:this.triggerMouseleave}},getDropoffEventMap:function(){return{mouseenter:this.bindEntryFn("sellername",this.renderDropoffTemplate),mouseleave:this.triggerMouseleave}},getPopoverEventMap:function(){return{mouseenter:this.popoverMouseenter,mouseleave:this.triggerMouseleave}},bindEntryFn:function(dataAttr,renderFn){return _.bind(function(e){this.triggerMouseenter(e,dataAttr,renderFn)},this)},triggerMouseenter:function(e,dataAttr,renderFn){window.clearTimeout(this._currentEnterFunction);window.clearTimeout(this._currentLeaveFunction);if(!this.lastEventedElement||$(e.currentTarget).data(dataAttr)!=this.lastEventedElement.data(dataAttr)){this._currentEnterFunction=window.setTimeout(_.bind(this.openPopover,this,e,renderFn),this.mouseEnterTimeoutMS)}},triggerMouseleave:function(){window.clearTimeout(this._currentEnterFunction);this._currentLeaveFunction=window.setTimeout(this.closePopover,this.mouseLeaveTimeoutMS)},popoverMouseenter:function(){window.clearTimeout(this._currentEnterFunction);window.clearTimeout(this._currentLeaveFunction)},openPopover:function(e,renderFn){this.closePopover();this.lastEventedElement=$(e.currentTarget);this.lastEventedElement.popover({html:true,placement:this.getPlacement(this.lastEventedElement),trigger:"manual",content:renderFn(this.lastEventedElement)}).popover("show");$('.popover .nav-tabs a[data-toggle="tab"]').click(function(e){e.preventDefault();$(this).tab("show");return false})},closePopover:function(){this.lastEventedElement&&this.lastEventedElement.popover("destroy");this.lastEventedElement=null},renderProductTemplate:function(el){var data=el.data();return this.mustache(_.extend({upid:data.upid,catId:data.catid.toString().replace(/[^0-9]/g,"")},this.staticContext),this.productTemplate)},renderDropoffTemplate:function(el){return this.mustache(_.extend(this.parseDropoffQueryParams(el.attr("href")),this.staticContext),this.dropoffTemplate)},getPlacement:function(el){var offset=el.offset(),left=offset.left,top=offset.top;if(left<=window.innerWidth/3){return"right"}else{if(left<=window.innerWidth/3*2){return top-$(window).scrollTop()<=window.innerHeight/2?"bottom":"top"}else{return"left"}}},parseDropoffQueryParams:function(href){var queryParamString=_(href.split("?")).last();var obj={};_(queryParamString.split("&")).each(function(i){var p=i.split("=");obj[decodeURIComponent(p[0])]=p.slice(1).join("=")});return obj}});ns("decide.views").FlashMessage=decide.ApplicationView.extend({flashHideTimeMS:500,initialize:function(){_.bindAll(this);this.prevNavStackLength=1;this.currentProductId=null;this.setTmpl("flashMessages");this.collection.on("add",this.render).on("remove",this.render).on("reset",this.render).on("flash:expire",this.flashExpireHandler);_(decide.bootstrap.flashMessages||[]).each(function(f){this.collection.add(new decide.models.FlashMessage({message:f.message,type:decide.flashMessages.getTypeByName(f.type)}))},this)},events:{"click a.close":"closeCallback"},render:function(){this.$el.html(this.mustache(this.collection.toJSON()))},flashExpireHandler:function(model){this.$("#"+model.getCid()).hide(this.flashHideTimeMS,_.bind(function(model){this.collection.remove(model)},this,model))},closeCallback:function(e){this.collection.remove(this.collection.getByCid($(e.target).parent().attr("id").replace("flash_message_","")));return false}});ns("decide.views").LightboxGate=decide.ApplicationView.extend({initialize:function(){_.bindAll(this);this.isOpen=false;this.isCurrentRouteProtected=null;this.openedByProtectedRoute=false;this.lightboxSignUp=new decide.views.LightboxSignUp({el:$("#lightboxSignUp"),model:decide.user});this.lightboxLogin=new decide.views.LightboxLogin({el:$("#lightboxLogin"),model:decide.user});$(document).on("click",'[data-modal="lightbox_gate"]',this.dataModalClickHandler);$(document).on("click","div.modal-backdrop",this.modalBackdropClickHandler);$(document).on("click","[data-pending_account_route]",this.pendingAccountRouteClickHandler);decide.eventBus.on("route",this.routeHandler).on("route:search",this.protectedRouteHandler).on("signup:success",this.closeLightbox).on("login:success",this.closeLightbox).on("login:required",this.openLightbox).on("logout",this.logoutHandler)},events:{shown:"lightboxOpenedCallback",hidden:"lightboxClosedCallback","click a.login":"login","click a.signup":"signup"},login:function(e){var email=this.$("#lightboxSignUp input[name=email]").val();this.$(".user_errors").empty();this.openLightbox({subview:"login"});this.lightboxLogin.setEmail(email);e.preventDefault()},signup:function(e){this.$(".user_errors").empty();this.openLightbox({subview:"signup"});e.preventDefault()},protectedRoutes:["search"],dataModalClickHandler:function(e){this.openLightbox({subview:$(e.target).data("modal-subview")})},modalBackdropClickHandler:function(e){if(this.isOpen){this.closeLightbox()}},pendingAccountRouteClickHandler:function(e){var $target=$(e.target),pendingRoute=$target.data("pending_account_route");this.model.setPendingAction({action:"route",view:pendingRoute});if(this.model.isUserLoggedIn()){this.model.executePendingAction()}else{this.openLightbox()}return false},routeHandler:function(eventData){this.isCurrentRouteProtected=_.bind(this.shouldProtectRoute,this,eventData);if(this.isOpen&&!this.isCurrentRouteProtected()){this.closeLightbox()}this.currentProductId=null},protectedRouteHandler:function(eventData){if(this.isCurrentRouteProtected&&this.isCurrentRouteProtected()&&_(decide.features).include("enableGate")){decide.signupState.set("signupSource","modal_prompt");this.openedByProtectedRoute=true;this.openLightbox(true,"signup",{signup:"lightbox.signup.header.promo"},{signup:"lightbox.signup.button.promo"})}this.currentProductId=eventData.productId},logoutHandler:function(){if(this.isCurrentRouteProtected&&this.isCurrentRouteProtected()&&decide.features.enableGate){decide.signupState.set("signupSource","modal_prompt");this.openedByProtectedRoute=true;this.openLightbox(true,"signup",{signup:"lightbox.signup.header.promo"},{signup:"lightbox.signup.button.promo"})}},shouldProtectRoute:function(eventData){return _(this.protectedRoutes).include(eventData.viewName)&&!$("body").attr("data-email")&&!this.model.hasClosedLightbox()},openLightbox:function(data){if(data.productId){this.$("form").each(function(i,form){var $form=$(form);$form.find("input[name=product_id]").remove();$('<input type="hidden" name="product_id" />').val(data.productId).appendTo($form)})}if(data.subview){this.lightboxLogin.toggle(data.subview==="login");this.lightboxSignUp.toggle(data.subview==="signup")}$(this.el).modal({backdrop:"static",show:true,keyboard:false})},closeLightbox:function(){$(this.el).modal("hide")},lightboxOpenedCallback:function(){this.isOpen=true;var eventData=this.getEventData();decide.eventBus.trigger("lightbox",eventData);decide.eventBus.trigger("lightbox:opened",eventData)},lightboxClosedCallback:function(){this.model.removePendingAction();this.isOpen=false;var eventData=this.getEventData();decide.eventBus.trigger("lightbox",eventData);decide.eventBus.trigger("lightbox:closed",eventData);if(this.openedByProtectedRoute){this.openedByProtectedRoute=false;this.model.setHasClosedLightbox(true)}},getEventData:function(){return{isOpen:this.isOpen,summary:decide.signupState.toSummaryString()}}});ns("decide.views").LightboxLogin=decide.LoginView.extend({initialize:function(){_.bindAll(this);decide.LoginView.prototype.initialize.call(this);$(document).on("facebook:ready",this.showFacebook);this.$header=$(this.el).find("h3");this.$closeButton=$(this.el).find("button.close");decide.eventBus.on("login:show",this.show);decide.eventBus.on("lightbox:closed",this.lightboxClosedCallback);this.resetErrors();this.$el.hide()},events:{"click .facebook_login":"loginWithFacebook","click a[data-view=sign_up]":"prepareSignUp","click a.switch_signup":"switchSignup","click a[data-view=forgot_password]":"updateAttemptedEmail","ajax:complete form":"ajaxComplete"},ajaxComplete:function(){this.flashMessages.reset()},success:function(){decide.LoginView.prototype.success.call(this)},setEmail:function(email){this.$("input[name=email]").val(email);this.$("input[name=password]").focus()},show:function(){this.resetErrors();this.$el.show()},hide:function(){this.$el.hide()},switchSignup:function(e){decide.eventBus.trigger("signup:show");this.$el.hide();e.preventDefault()},lightboxClosedCallback:function(){this.$("input").val("")}});ns("decide.views").LightboxRegistrationPrompt=decide.ApplicationView.extend({el:"#lightboxRegistrationPrompt",blockedPages:["member","member_join","search"],initialize:function(){_.bindAll(this);this.pageViewCount=decide.user.getPageViewCount();this.setTmpl("lightboxRegistrationPrompt");decide.eventBus.on("route",this.routeHandler);$(window).unload(this.unloadHandler)},events:{shown:"shownHandler",hidden:"hiddenHandler","click a.btn":"buttonClickHandler"},routeHandler:function(){this.closeModal();if(decide.features.registrationPrompt){this.pageViewCount+=1;decide.user.setPageViewCount(this.pageViewCount);if(this.pageViewCount===decide.clientSettings.registrationPromptNPageViews&&!decide.membershipFeatures.paid&&!_(this.blockedPages).contains($("body").attr("data-view"))){this.openModal()}}},unloadHandler:function(){if(decide.features.registrationPrompt){decide.user.setPageViewCount(this.pageViewCount)}},shownHandler:function(){this._generateEvent("open")},hiddenHandler:function(){this._generateEvent("close")},buttonClickHandler:function(){this._generateEvent("click");decide.user.setPrompted()},openModal:function(){this.render().$el.modal("show")},closeModal:function(){this.$el.modal("hide")},_generateEvent:function(action){decide.eventBus.trigger("prompt-lightbox",{action:action,label:decide.pageInfo.find("view")})}});ns("decide.views").LightboxSignUp=decide.SignUpView.extend({initialize:function(){_.bindAll(this);this.delegateEvents();decide.SignUpView.prototype.initialize.call(this);decide.eventBus.on("signup:show",this.show);decide.eventBus.on("lightbox:closed",this.lightboxClosedCallback);$(document).on("click","[data-signup-source]",this.setSignupSource);this.resetErrors()},events:{"click .facebook_login":"getFacebookDetails","click a.switch_login":"switchLogin"},setSignupSource:function(e){decide.signupState.set("signupSource",$(e.target).data("signup-source"))},success:function(){decide.SignUpView.prototype.success.call(this)},show:function(){this.resetErrors();this.$el.show()},hide:function(){this.$el.hide()},switchLogin:function(e){decide.eventBus.trigger("login:show");this.hide();e.preventDefault()},lightboxClosedCallback:function(){this.$("input").val("")}});ns("decide.views").LightboxSuggestBrowser=decide.ApplicationView.extend({el:"#suggest_browser",initialize:function(){_.bindAll(this);this.isOpen=false;if(this.isUnsupportedBrowser()){$(document).on("click","div.modal-backdrop",this.modalBackdropClickHandler);decide.eventBus.on("route",this.routeHandler)}},events:{shown:"lightboxOpenedCallback",hidden:"lightboxClosedCallback"},modalBackdropClickHandler:function(e){if(this.isOpen&&!this.isProtectedPage()){this.closeLightbox()}},routeHandler:function(){this.openLightbox()},openLightbox:function(){this.$el.modal({backdrop:"static",show:true});if(this.isProtectedPage()){this.$el.find(".close").hide()}else{this.$el.find(".close").show()}},closeLightbox:function(){this.$el.modal("hide")},lightboxOpenedCallback:function(){this.isOpen=true},lightboxClosedCallback:function(){this.isOpen=false},isUnsupportedBrowser:function(){return $.browser.msie&&parseInt($.browser.version,10)<8},isProtectedPage:function(){return decide.pageInfo.find("view")==="member-join"||window.location.pathname.match(/member\-join/i)}});ns("decide.views").Nav=decide.ApplicationView.extend({initialize:function(){_.bindAll(this);this.$searchInputs=$(".query_input");this.$searchForms=$(".search_form");this.$resetSearchButton=$(".search_form .reset");this.attachFullAutoComplete();$(".ui-menu-item a").live("click",this.autoCompleteItemClick);this._showResetSearchButton();this.$el.find("#back_link").click(this.goBack);this.$el.find("#next_link.search_next").click(this.goNext);this.$el.find("#track_link").click(this.toggleProductAlert);this.$el.find(".query_input").live("focus",this.focusSearch);this.$el.find(".query_input").live("keyup",this.suggestQuery);this.$el.find("#cancel_or_scan").live("click",this.cancelOrScan);this.$el.find(".search_form").live("reset",this.resetClicked)},_showResetSearchButton:function(){var term=this.$searchInputs.filter(function(){return $(this).val()}).val();if(this.$resetSearchButton){if(_.isEmpty(term)){this.$resetSearchButton.hide()}else{this.$resetSearchButton.show()}}},search:function search(e){var query=$(e.currentTarget).find(".query_input").val();$(e.currentTarget).find("input").blur();this.dismissSearch();this._performSearch(query);return false},_performSearch:function(query,facets){query=query&&$.trim(query)||"";facets=facets||"";if(!_.isEmpty(query)){if(decide.isApp){this.trigger("route",{query:query,view:"search"})}else{this.searchByNavigating(query,facets)}}},searchByNavigating:function(query,facets){document.location="/search/"+encodeURIComponent(query)},autoCompleteItemClick:function autoCompleteItemClick(e){var query=$(e.currentTarget).text();var $queryInput=$(".query_input");$queryInput.val(query);$queryInput.blur();this._performSearch(query)},sr:function(){return this.model.get("searchResults")},goBack:function(){window.history.back();return false},goNext:function(e){if(this._searchHelper&&this._searchHelper.isExpanded()){this._searchHelper.clear()}this.dismissSearch();var $body=$(document.body);var view=$body.data("view");if(view==="search"){this.toggleMobileFacets()}else{if(view==="account"){var that=this;var redirectAfterLogout=function redirectAfterLogout(response){that.model.get("user").logout();window.location="/"};if(_.isEmpty(decide.util.udc.getUdc())){FB.logout(redirectAfterLogout)}else{redirectAfterLogout()}}}return false},hideFromMobileClass:"hide-from-mobile",hideMobileFacets:function(){if($("#results").hasClass(this.hideFromMobileClass)){if(decide.env.isTablet()){window.scrollTo(0,0)}$("body").removeClass("search_mobile_facets");$("#next_link").html("Filter");$("#results").removeClass(this.hideFromMobileClass);$("#facets").addClass(this.hideFromMobileClass)}},showMobileFacets:function(){if(!$("#results").hasClass(this.hideFromMobileClass)){if(decide.env.isTablet()){window.scrollTo(0,0)}$("body").addClass("search_mobile_facets");$("#next_link").html("Cancel");$("#results").addClass(this.hideFromMobileClass);$("#facets").removeClass(this.hideFromMobileClass)}},toggleMobileFacets:function(){if($("#results").hasClass(this.hideFromMobileClass)){this.hideMobileFacets()}else{this.showMobileFacets()}},focusSearch:function focusSearch(e){console.log("focus search");$("#cancel_or_scan").text("Cancel");this.$searchForms.addClass("focused");return true},dismissSearch:function dismissSearch(e){console.log("dismiss search");var sr=this.sr();if(sr){this.$searchInputs.val(sr.get("query"))}this._showResetSearchButton();this.$searchForms.removeClass("focused");if(this._searchHelper){this._searchHelper.clear()}return false},cancelOrScan:function cancelOrScan(e){if(this.$searchForms.hasClass("focused")){this.dismissSearch(e)}return false},resetClicked:function resetClicked(e){console.log("reset clicked");this.$searchInputs.val("");this._showResetSearchButton();if(e.currentTarget.tagName.toUpperCase()=="FORM"){$(e.currentTarget.elements.q).focus()}else{$(e.currentTarget).closest("form").find("input").focus()}return false},suggestQuery:function suggestQuery(e){var term=$(e.currentTarget).val();console.log("suggesting query:"+term);this._showResetSearchButton();if(this._mobileAutoComplete){this._mobileAutoComplete.set({term:term})}},toggleProductAlert:function(){var message=$("#header_wrapper").hasClass("alert_set")?"Stop tracking this product?":"Set an alert and track this product?";var confirm=window.confirm(message);return confirm},attachFullAutoComplete:function attachFullAutoComplete(){var prod=py.ENDPOINT||"https://www.decide.com";var acBaseUrl="/autocomplete-ws/ac";if(decide.env.isPhoneGap()){acBaseUrl=prod+acBaseUrl}if(!$("html").is(".ie7")){var $search=$(".query_input");$search.each(function attachACHelper(index){var $element=$(this);(!$element.hasClass("mobile"))&&$element.autocomplete({source:function(req,resp){resp()},search:function(e,ui){var $search=$(e.currentTarget);var isPopular=($search.val()==="");$search.autocomplete("option","source",(isPopular)?["iPhone 4S","Tablets","eReaders","MacBook Air","Canon Rebel T3i"]:acBaseUrl);$(".ui-autocomplete").toggleClass("popular",isPopular)},minLength:0,delay:0,position:{my:"left top",at:"left bottom",collision:"none",offset:"0 -6"},open:function(){var $ac=$(".ui-autocomplete");$ac.css({"padding-left":"6px","padding-right":"6px",top:$element.height()+8,width:$element.width(),"z-index":$search.css("z-index")-1});if($ac.hasClass("popular")){$ac.prepend($("<li />").text("Popular Searches").addClass("popular_text"))}$ac.find(".ui-menu-item a").each(function(i,el){var $el=$(el);var htmlText=$el.text().replace(new RegExp($.trim($search.val()),"i"),"<b>"+$search.val()+"</b>");$el.html(htmlText)});$(".ui-autocomplete.ui-menu .ui-menu-item:nth-child(n+7)").hide()},appendTo:$element.parent()})})}}});ns("decide.views").ScanInProgress=decide.ApplicationView.extend({initialize:function init(){this.msgFormat=decide.message.formatter.format;this.delegateEvents();_.bindAll(this,"render");this.render()},render:function render(){this.$el.html($.mustache("<p>{{message}}</p>",{message:this.msgFormat("mobile.scanning")}));this.trigger("newcontent")}});ns("decide.views").ScrollSection=decide.ApplicationView.extend({initialize:function init(){this.delegateEvents();_.bindAll(this);this.isNativeScrolling=decide.env.isPositionFixedSupported();this._iscroll=null;if(!this.isNativeScrolling&&this.el){this._prepScrollSection();this._updateHeight();this._iscroll=new iScroll(this.el,{hScroll:false,hScrollBar:false,onScrollEnd:this.triggerScroll,useTransition:true})}},triggerScroll:function(){this.$el.trigger("scroll")},_distanceFromBottom:function(){var iscroll=this._iscroll;if(iscroll){return iscroll.scrollerH-iscroll.wrapperH+iscroll.y}return NaN},_percentScrolled:function(){var iscroll=this._iscroll;if(iscroll){return -iscroll.y/(iscroll.scrollerH-iscroll.wrapperH)}return NaN},refresh:function(){if(this._iscroll==null){return}this._updateHeight();var iscroll=this._iscroll;setTimeout(function(){iscroll.refresh()},0)},_prepScrollSection:function(){if(this.$el.children.length<2){return}var $contents=this.$el.contents().detach();var $scrollContent=$('<div class="scroll_content"></div>');$contents.appendTo($scrollContent);$scrollContent.appendTo(this.$el)},_updateHeight:function(){var offset=this.$el.offset();if(offset!=null){var newHeight=$(window).height()-offset.top;this.$el.height(newHeight);this.$el.css("position","relative")}}});ns("decide.views").SearchHelper=decide.ApplicationView.extend({initialize:function init(args){this.setElement($("#searchHelper"));if(args.nav){this.nav=args.nav}_.bindAll(this,"showHistory","showSuggestions","clear","isExpanded");this.render();this.showHelper=false;this._scrollSection=new decide.views.ScrollSection({el:this.$("#searchHelper")})},events:{"click .newQuery":"search","click a":"clear"},render:function render(){var container=$("<div/>");container.append($('<ul id="suggestions"></ul>'));this.$el.append(container.contents())},search:function search(e){var query=$(e.currentTarget).attr("data-value");query=decodeURIComponent(query);this.$el.removeClass("has_suggestions");if(this.nav){this.nav.$(":focus").blur();this.nav.dismissSearch()}var index=$(e.currentTarget).prevAll().length+1;decide.ga.trackEvent("mobile autocomplete",$("body").data("view"),query,index);this.trigger("route",{query:query,page:1,view:"search"});return false},showHistory:function showHistory(queryArray){if(!this.showHelper){return}var data=[];for(var index in queryArray){var query=queryArray[index];data.push({value:query,label:query})}if(data.length>0){this.$el.addClass("has_suggestions");this._renderSuggestions(data,true)}},showSuggestions:function showSuggestions(){if(!this.showHelper){return}var suggestions=this.model.get("results")||[];if(suggestions.length>0){this.$el.addClass("has_suggestions")}else{this.$el.removeClass("has_suggestions")}this._renderSuggestions(suggestions,false)},show:function start(){this.showHelper=true},clear:function clear(){this.showHelper=false;this.$el.removeClass("has_suggestions")},isExpanded:function isExpanded(){return this.$el.hasClass("has_suggestions")},_renderSuggestions:function _renderSuggestions(suggestions,isHistory){var $suggestions=$("#suggestions");var container=$("<div/>");for(var index=0;index<suggestions.length;index++){var suggestion=suggestions[index];var html=_.template('<li><a href="/search/{{ encodeURIComponent(value) }}">{{ label }}</a></li>',suggestion);container.append($(html))}$suggestions.empty();$suggestions.append(container.contents());if(this._scrollSection){this._scrollSection.refresh()}}});ns("decide.views").VideoPlayer=decide.ApplicationView.extend({el:"#video_player",initialize:function(){_.bindAll(this);this.$title=this.$(".video-title");this.$iframe=this.$("iframe");decide.eventBus.on("route",this.closeModal);$(document).on("click","a[data-video_url]",this.openModal)},events:{hidden:"hiddenCallback"},openModal:function(e){this.$el.show();var $el=$(e.currentTarget),url=$el.data().video_url,title=$el.data().video_title;this.setUrlAndTitle(url,title);this.$("#decide_video_player").modal("show");e.preventDefault()},closeModal:function(){this.$("#decide_video_player").modal("hide")},setUrlAndTitle:function(url,title){this.$title=title;this.$iframe.attr("src",url)},hiddenCallback:function(){this.setUrlAndTitle("","");this.$el.hide()}});ns("decide.views").iOSHelper=decide.ApplicationView.extend({initialize:function(){_.bindAll(this);this.$el.on("touchend",".touch_link",this.iosClick)},iosClick:function(e){var $el=$(e.currentTarget);window.location=$el.attr("href")}});ns("decide.routers").BrowseRouter=decide.ApplicationRouter.extend({initialize:function(){_.bindAll(this)},routes:{":subpage":"handleRoute"},handleRoute:function(subpage){if(subpage){$("#category_page_contents .container.all_categories[data-type!="+subpage+"]").hide()}}});ns("decide.routers").GlobalRouter=decide.ApplicationRouter.extend({initialize:function(){console.log("initializing GlobalRouter");decide.isApp=true;var splashScreenShown=this._showSplashScreen();this.sharedModels={searchResults:new decide.models.SearchResults(),user:decide.user,dealsModel:new decide.models.Deals(),scanner:new decide.models.Scanner()};this._buildPageContainers();this.nav.model.set({searchResults:this.sharedModels.searchResults,scanner:this.sharedModels.scanner});this.pages={browse:new decide.views.BrowsePage({el:"#browse_page_contents"}),search:new decide.views.SearchPage({el:"#search_page_contents",model:this.sharedModels.searchResults}),product:new decide.views.ProductPage({el:"#product_page_contents",sharedModels:this.sharedModels}),account:new decide.views.AccountPage({el:"#account_page_contents",model:decide.user}),member:new decide.views.MemberPage({el:$("#member_page_contents"),model:decide.user}),member_join:new decide.views.MemberJoinPage({el:$("#member_join_page_contents"),model:decide.user})};this.$body=$("body");_.bindAll(this);this.sharedModels.searchResults.bind("change",this.searchResultsChanged);this.nav.off("route");_.each(_.values(this.pages).concat([decide.user,this.nav]),function bindRouteToPage(page){page.bind("route",this.updateRoute)},this);this.sharedModels.scanner.bind("sync:success",this.showScannedProduct);this.sharedModels.scanner.bind("sync:error",this.scanningFailed);this.sharedModels.scanner.bind("unsupported",this.showScannerHelp);this.nav.bind("scan",this.scan);this.nav.bind("goBack",this.clearScanner);this.sharedModels.user.bind("change:productAlertsById",this.updateProductAlertStatus);if(typeof(respond)!=="undefined"){respond.update()}$("html").addClass("loaded")},routes:{browse:"routeToBrowse",browseCategories:"routeToBrowse","browseCategories/*subpage":"routeToBrowse","search/:query":"routeToSearch",search:"routeToSearch","p/:productId":"routeToProduct","p/:productId/:subpage":"routeToProduct","product/:productId":"routeToProduct","product/:productId/:subpage":"routeToProduct",login:"routeToLogin",signup:"routeToSignUp","login/password":"routeToForgotPassword","signup/upgrade":"routeToUpgradeAccount",account:"routeToAccount","account/:section":"routeToAccount",member:"routeToMember","member-join":"routeToMemberJoin"},routeToBrowse:function routeToBrowse(subpage){console.log("routing to browse page",subpage);this.changeViewTo("browse",subpage)},routeToSearch:function(queryOrParams,params){var attrs=queryOrParams;if(attrs&&!_.isObject(attrs)){attrs=_.extend(params||{},{q:queryOrParams})}if(attrs){this.pages.search.search(attrs)}this.changeViewTo("search")},routeToProduct:function(productId,subpage){if(productId.indexOf("-")>-1){var numbers=productId.split("?")[0].match(/.*-(\d+)/);numbers&&(productId=_.last(numbers))}console.log("routing to product with productId:"+productId);var product=this.sharedModels.searchResults.getProductById(productId);this.pages.product.render(product,subpage);this.changeViewTo("product",subpage,{productId:productId,product:product});this.updateProductAlertStatus(productId)},routeToLogin:function routeToLogin(){this.changeViewTo("login")},routeToSignUp:function routeToSignUp(){console.warn("Sign Up router not loaded, args:",arguments);this.changeViewTo("sign_up")},routeToForgotPassword:function routeToForgotPassword(){console.warn("ForgotPassword router not loaded, args:",arguments);this.changeViewTo("forgot_password")},routeToUpgradeAccount:function routeToUpgradeAccount(){this.changeViewTo("upgrade_account")},routeToMember:function(params){this.pages.member.params=params||{};this.changeViewTo("member")},routeToMemberJoin:function(params){this.pages.member_join.params=params||{};this.changeViewTo("member_join")},routeToAccount:function routeToAccount(section){section=section||"alerts";this.changeViewTo("account",section)},changeViewTo:function changeViewTo(viewName,subpage,eventData){var oldViewName=this.currentViewName(),newPage=this.getPage(viewName),viewHasChanged=false;if(viewName!==oldViewName&&newPage){viewHasChanged=true;var oldPage=this.getPage(oldViewName);oldPage&&oldPage.hide();this.$body.removeClass(this.currentViewClassName());this.$body.data("view",viewName);this.$body.addClass(this.currentViewClassName());decide.env.isFullsite()&&this.$body.scrollTop(0)}else{if(viewName===oldViewName){viewHasChanged=true}}if(typeof(subpage)!=="string"){this.removeSubpage()}else{this.addSubpage(subpage)}if(newPage){newPage.show(subpage);decide.history.routeChanges.length&&newPage.updateTitle()}this.nav.generateNavText(eventData);var triggerEventData=_.extend({viewName:viewName,subpage:subpage},eventData);decide.eventBus.trigger("route",this.nav.navStack,triggerEventData);decide.eventBus.trigger("route:"+viewName,this.nav.navStack,triggerEventData);return viewHasChanged},getPage:function(name){return this.pages[name]},currentViewClassName:function(){return this.currentViewName()+"_page"},currentViewName:function(){return this.$body.data("view")||"search"},currentSubpageName:function(){return this.$body.attr("data-subpage")},currentView:function(){return this.pages[this.currentViewName()]},removeSubpage:function removeSubpage(){console.log("removing subpage");var currentSubpage=this.$body.attr("data-subpage");this.$body.attr("data-subpage","");this.$body.removeClass("subpage");this.$body.removeClass(currentSubpage+"_subpage")},addSubpage:function addSubpage(subpage){console.log("adding subpage",subpage);this.removeSubpage();this.$body.attr("data-subpage",subpage);this.$body.addClass("subpage");this.$body.addClass(subpage+"_subpage")},updateRoute:function(params,suppressHistoryItem){suppressHistoryItem=!!suppressHistoryItem;params=params||{};var fragment,options={trigger:decide.env.hasPushState()};var targetView=params.url&&params.url.substring(1)||params.view;if(targetView&&targetView.indexOf("/")>=0){targetView=targetView.substring(0,targetView.indexOf("/"))}if(targetView=="p"){targetView="product"}var loggedInPages=["account","alerts_track","settings_track"];var isLoggedInPage=function(){return _.any(loggedInPages,function(page){return targetView.indexOf(page)>-1})};if(targetView&&isLoggedInPage()&&!decide.user.isUserLoggedIn()){decide.user.setPendingAction({action:"route",view:targetView});params.url="/login"}if("url" in params){fragment=params.url.replace("#","/");if(decide.env.isPhoneGap()&&$(document.body).data("view")==targetView){suppressHistoryItem=true}var p=document.location.pathname;if(!decide.env.hasPushState()){document.location=params.url;console.log("GlobalRouter full redirect to "+params.url);return}}else{if(this.currentViewName()==params.view&&this.currentSubpageName()!==""){suppressHistoryItem=true}else{if((decide.env.isPhoneGap()||decide.env.isTablet())&&this.currentViewName()==params.view&&params.view==="search"){suppressHistoryItem=true}}if(params.view==="search"){if(typeof(params.query)!=="undefined"&&params.query!==this.sharedModels.searchResults.get("query")){var defaults=_.extend({},this.sharedModels.searchResults.defaults());params=_.extend(defaults,params);$(document.body).removeClass("browse")}else{if(typeof(params.subpage)==="undefined"){var shouldSuppress=this.sharedModels.searchResults.setRouteParams(params);if(this.currentViewName()===params.view){suppressHistoryItem=suppressHistoryItem||shouldSuppress}}}}fragment=this._generateFragment(params)}_.extend(options,{replace:suppressHistoryItem});console.log("routed to "+fragment+"with options"+JSON.stringify(options));if(fragment===window.location.pathname&&$(document.body).data("view")==="product"){var path=fragment.substring(1);var parts=path.split("/");if(parts.length>2){this.pages.product.scrollToSubpage(parts[2])}}if(fragment.indexOf("/")===0){fragment=fragment.substring(1)}this.navigate(fragment,options)},_isSubpageUrl:function _isSubpageUrl(url){if(url[0]=="/"){url=url.substr(1)}var parts=url.split("/");if(parts.length>0){var urlViewName=this._getViewNameFromUrlRoot(parts[0]);return(this.currentViewName()==urlViewName)}return false},_getViewNameFromUrlRoot:function getViewNameFromUrlRoot(urlRoot){if(urlRoot=="p"){return"product"}return urlRoot},_serverSideUrlPortion:function(){return window.location.pathname+window.location.search},_generateFragment:function _generateFragment(params){var view=params.view||$(document.body).data("view");var fragment="";var pagePieces=view.split("?");pagePieces[0].toLowerCase();page=pagePieces.join("?");if(page==="browse"||page==="browseCategories"){page="browseCategories";fragment=""}else{if(page==="search"){if(typeof(params.subpage)!="undefined"){params.page=params.subpage}fragment=this.pages.search.generateFragment(params)}else{if("productId" in params){fragment=params.productId+""}else{if(page=="product"){var renderedProduct=this.pages.product.product;if(renderedProduct!=null){page=renderedProduct.get("canonicalUrl");if(typeof(params.subpage)!="undefined"){fragment=params.subpage}}else{console.warn("can't generate fragment for unknown product.")}}else{if(typeof(params.subpage)!="undefined"){fragment=params.subpage}}}}}if(!_.isEmpty(fragment)){return(fragment.indexOf("?")===0)?(page+fragment):(page+"/"+fragment)}return page},searchResultsChanged:function(){this.nav.generateNavText()},_buildPageContainers:function _buildPageContainers(){var $outerWrapper=$(".outer_wrapper");var pageNameList=["browse","search","product","account","login","sign_up","forgot_password","deals","member","member_join"];for(var index=0;index<pageNameList.length;index++){var pageName=pageNameList[index],id=pageName+"_page_contents";$("#"+id).length||$outerWrapper.after($('<section id="'+id+'" />'))}},_showSplashScreen:function _showSplashScreen(){if(decide.env.isPhoneGap()){return false}var splash=$(".app_download");var settings=decide.util.udc.getValue("settings")||{};var hasSeenSplash=settings.hasSeenMobileSplash;if(splash.length>0&&(decide.env.isIOSDevice()&&decide.env.getIOSVersion()<6)&&(typeof(hasSeenSplash)==="undefined"||!hasSeenSplash)){splash.addClass("shown");settings.hasSeenMobileSplash=true;decide.util.udc.setValue("settings",settings);var dismiss=splash.find(".no_thanks");dismiss.bind("click",this._dismissSplashScreen);return true}return false},_dismissSplashScreen:function _dismissSplashScreen(e){$(".app_download").removeClass("shown");py.geoloc.updateLocation();return false},updateProductAlertStatus:function updateProductAlertStatus(id){if(!_.isNumber(id)){var product=this.pages.product.product;id=product&&product.get("id")||id}var isAlertSet=false;if(typeof(id)!=="undefined"){var alertsById=decide.user.get("productAlertsById");if(decide.user.isUserLoggedIn()&&typeof(alertsById)!=="undefined"){isAlertSet=(id in alertsById)}}this.nav.setAlertDisplay(isAlertSet)},scan:function scan(){if(window.plugins&&window.plugins.barcodeScanner){$(document).off("backbutton",this.nav.goBack);window.plugins.barcodeScanner.scan(this._scanSuccess,this._scanFailure)}else{this._scanFailure("Scanning not supported in this environment")}},clearScanner:function(){this.sharedModels.scanner.set({query:""})},showScannedProduct:function showScannedProduct(){var productId=this.sharedModels.scanner.get("productId");if(productId==null){var query=this.sharedModels.scanner.get("query");if(query!=""){this.sharedModels.searchResults.set({query:""})}this.pages.search.showErrorPage("scan_fail",{scanData:query});if(query!==""){this.updateRoute({view:"search"})}}else{this.updateRoute({productId:productId,view:"product"})}},scanningFailed:function scanningFailed(){var error_message="The scanning service appears to be down. Please try again later.";if(navigator&&navigator.notification&&navigator.notification.alert){navigator.notification.alert(error_message,_.identity,"Whoops")}else{alert(error_message)}},showScannerHelp:function showScannerHelp(query){this.updateRoute({view:"search"})},addScanToSearchHistory:function addScanToSearchHistory(){var scannedId=this.sharedModels.scanner.get("productId");if(scannedId!=null){var product=this.searchResults.getProductById(scannedId);if(product!=null){this.nav.addToSearchHistory(product.get("title"))}}},_scanSuccess:function(value){if(value.cancelled){this._scanFailure("User cancelled the scan.")}else{var connectionStatus=navigator.network&&navigator.network.connection&&navigator.network.connection.type||"";if(connectionStatus!==""&&(connectionStatus===Connection.NONE||connectionStatus===Connection.UNKNOWN)){this._offlineError()}else{this.sharedModels.scanner.set({query:value.text})}}var that=this;setTimeout(function(){$(document).on("backbutton",that.nav.goBack)},1000)},_scanFailure:function(error){console.warn("scanning has failed. error: "+error)},_offlineError:function _offlineError(error_message){error_message=error_message||"The internet connection appears to be offline.";var alertFunction=function(){this._offlineErrorTimeout=null;if(navigator&&navigator.notification&&navigator.notification.alert){navigator.notification.alert(error_message,_.identity,"Whoops")}else{alert(error_message)}};if(this._offlineErrorTimeout){clearTimeout(this._offlineErrorTimeout)}this._offlineErrorTimeout=setTimeout(alertFunction,200)}});ns("decide.routers").ProductRouter=decide.ApplicationRouter.extend({initialize:function(){console.log("Initializing ProductRouter");_.bindAll(this)},routes:{":subpage":"handleRoute"},handleRoute:function(subpage){console.log("Route to subpage: ",subpage);if(subpage){$("body").addClass("subpage").attr("data-subpage",subpage)}else{$("body").removeClass("subpage").removeAttr("data-subpage")}decide.eventBus.trigger("route:product:"+subpage);decide.eventBus.trigger("route:product")}});ns("decide.views").CategoryGrid=decide.ApplicationView.extend({initialize:function(){_.bindAll(this);this.$("ul.thumbnails li:nth-child(3n+1)").addClass("first")}});ns("decide.views").HomePage=decide.ApplicationPage.extend({initialize:function(){_.bindAll(this);this.$(".carousel").carousel();!$("html").is(".ie")&&$("#home_page_contents .query_input").focus();this.addView({navToggle:new decide.views.NavToggle({el:this.$(".product_grid")}),categoryGrid:new decide.views.CategoryGrid({el:this.$(".product_grid .items")})});this.$carouselCaptions=this.$(".carousel-caption > h4");this.generateHerouselEvent("pane1");this.detectAndHandleRetina()},events:{"click .clickable":"clickable","mouseover #herousel":"herouselMouseoverHandler","mouseout #herousel":"herouselMouseoutHandler","mouseover .carousel-indicators > li":"herouselControlMouseoverHandler","mouseover .carousel-control":"herouselControlMouseoverHandler","slid #herousel":"herouselSlidHandler"},clickable:function(e){window.location=$(e.currentTarget).parent().find("a").attr("href")},detectAndHandleRetina:function(){if(window.devicePixelRatio>1){this.$(".what_we_do .experiment_none img").map(function(i,el){var $el=$(el);var oldImg=$el.attr("src");var dotIndex=oldImg.lastIndexOf(".");$el.attr("src",oldImg.substring(0,dotIndex)+"@2x"+oldImg.substring(dotIndex))})}},herouselMouseoverHandler:function(e){this.$carouselCaptions.addClass("hover")},herouselMouseoutHandler:function(e){this.$carouselCaptions.removeClass("hover")},herouselControlMouseoverHandler:function(e){e.preventDefault&&e.preventDefault();e.stopPropagation&&e.stopPropagation()},herouselSlidHandler:function(e){this.generateHerouselEvent($(e.target).find(".item.active").first().data("label"))},generateHerouselEvent:function(pane){decide.eventBus.trigger("herousel:pane:shown",{pane:pane})}});ns("decide.views").NavToggle=decide.ApplicationView.extend({initialize:function(){_.bindAll(this);this.$items=this.$(".items");this.activate(this.$("nav li:first"))},events:{"click nav li":"navItemClick"},navItemClick:function(e){this.activate($(e.currentTarget))},activate:function($el){this.$el.find("li").removeClass("active");$el.addClass("active");this.$items.children().hide();this.$items.find("."+$el.data("target")).show()}});ns("decide.views").TopProducts=decide.ApplicationView.extend({overrides:{30743403:{title:"iPhone 4S",imageName:"product_iphone",analyticsName:"top-products-iphone-4S"},15119957:{title:"Weber Grill",imageName:"product_grill",analyticsName:"top-products-weber-grill"},28175631:{title:"MacBook Air",imageName:"product_macbook_air",analyticsName:"top-products-macbook-air"},18883612:{title:"LG Dryer",imageName:"product_dryer",analyticsName:"top-products-lg-dryer"},30714290:{title:"Kindle Fire",imageName:"product_fire",analyticsName:"top-products-kindle-fire"}},overridesOrdered:[30743403,15119957,28175631,18883612,30714290],initialize:function(options){this.itemTemplate=this.tmpl("topProduct");_.bindAll(this,"render");if(options.overrides){this.overrides=options.overrides}this.model.get("products").bind("batchAdd",this.render);this.model.fetch()},render:function(){var $container=$("<div />");var p;var products=this.model.get("products");_.each(this.overridesOrdered,function(id){p=products.get(id);if(p){var override=this.overrides[p.id];var map=p.getMap("product");var category="none";for(var key in p.get("categories")){category=p.get("categories")[key]}if(map.tip===""||map.tip===null){map.tip="buy"}$container.append($($.mustache(this.itemTemplate,_.extend(map,{imageName:override.imageName,tip:map.tip.toLowerCase(),title:override.title,query:encodeURIComponent(override.title)+"/1/"+id,analyticsName:override.analyticsName,category:category}))).hide())}},this);this.$el.html($container.children().each(function(i){if($("body").hasClass("404_page")){$(this).show()}else{$(this).delay(i*80).fadeIn()}}));return this}});