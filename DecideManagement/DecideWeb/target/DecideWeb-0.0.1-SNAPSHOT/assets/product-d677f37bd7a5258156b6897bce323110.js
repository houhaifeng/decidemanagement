ns("decide.views").BaseModelControl=decide.ApplicationView.extend({initialize:function(){_.bindAll(this);this.label=this.$(".show-base-models").data("label");this.baseModels=new decide.views.BaseModels({el:this.$(".base_models"),model:this.model});this.triggerEvent("shown")},events:{"click .show-base-models":"showBaseModels"},showBaseModels:function(e){var pd=this.model.get("productData");if(pd&&pd.baseModelData){this.triggerEvent("clicked");this.baseModels.render().show()}else{this.model.fetch({success:this.showBaseModels})}e&&e.preventDefault&&e.preventDefault()},triggerEvent:function(action){var urlRegex=/\/p\/.*?([0-9]+)$/,matches=urlRegex.exec(window.location.pathname),pageProductId=parseInt(matches&&matches[1]);if(this.label&&decide.pageInfo.find("view")==="product"&&this.model&&this.model.get("id")===pageProductId){decide.eventBus.trigger("variants-link-prod",this.generateEvent(action))}else{if(this.label&&decide.pageInfo.find("view")==="search"&&action==="clicked"){decide.eventBus.trigger("variants-link-search",this.generateEvent(action))}}},generateEvent:function(action){return{action:action,label:this.label}}});ns("decide.views").BaseModels=decide.ApplicationView.extend({initialize:function(){_.bindAll(this);this.setTmpl("baseModels");this.$html=$("html");decide.eventBus.on("route",this.closeModal)},events:{"shown div.modal":"shownCallback","hidden div.modal":"hiddenCallback","click a":"closeModal"},shownCallback:function(){this.$html.css("overflow","hidden")},hiddenCallback:function(){this.$html.css("overflow","auto");$(".modal-backdrop").first().remove()},syncStart:function(){$("body").addClass("loading page-loading")},syncSuccess:function(){$("body").removeClass("loading page-loading")},show:function(){this.$("#base-model-modal").modal({fade:true});return this},closeModal:function(){this.$el.find("div.modal").modal("hide")},render:function(){var data=this.ellipsizeBaseModels(this.model.toJSON());this.$el.html(this.mustache(data));return this},ellipsizeBaseModels:function(data){data.productData.baseModelData.models=_.map(data.productData.baseModelData.models,function(model){var ellipsizedTitleAndTopFeatures=decide.helpers.multiStringEllipsis([model.title,model.topFeatures[0]],110);model.title=ellipsizedTitleAndTopFeatures[0];model.topFeatures[0]=ellipsizedTitleAndTopFeatures[1];return model});return data}});ns("decide.views").LightboxPriceGuarantee=decide.ApplicationView.extend({initialize:function(){_.bindAll(this);this.isOpen=false;decide.eventBus.on("route",this.closeLightbox);$(document).on("click",'[data-lightbox="lightboxPriceGuarantee"]',this.handleLightboxClick)},events:{shown:"lightboxOpenedCallback",hidden:"lightboxClosedCallback","click a.btn.upgrade":"clickUpgradeButtonCallback"},handleLightboxClick:function(e){this.render().$el.modal("show")},closeLightbox:function(){this.$el.modal("hide")},lightboxOpenedCallback:function(){this.isOpen=true;var e=this.getEventData("open");decide.eventBus.trigger("pg-lightbox",e);decide.eventBus.trigger("pg-lightbox:opened",e)},lightboxClosedCallback:function(){this.isOpen=false;var e=this.getEventData("close");decide.eventBus.trigger("pg-lightbox",e);decide.eventBus.trigger("pg-lightbox:closed",e)},clickUpgradeButtonCallback:function(){decide.eventBus.trigger("pg-lightbox",this.getEventData("button click"))},getEventData:function(action){return{action:action,label:decide.membershipFeatures.paid?"member":"nonmember"}}});ns("decide.views").Local=decide.ApplicationView.extend({initialize:function(){this.MAX_ZOOM=12;this.setTmpl("local");this.templateOffers=this.tmpl("local_localOffers");this.templatePager=this.tmpl("pager");this.templatePriceButton=this.tmpl("productInfo_priceButton");this.templatePriceButtonMobile=this.tmpl("productInfo_priceButton_mobile");this.markers=[];this.markersById={};_.bindAll(this);this.model.set({sort:"DISTANCE"}).bind("sync:complete",this.render);this.pager=new decide.contexts.Pager({model:this.model.get("offers"),pageSize:4});this.map=null;this.model.isLoaded&&this.render()},events:{"click .arrow_button.prev":"changePage","click .arrow_button.next":"changePage","click .store":"storeClick"},changePage:function(e){var $el=$(e.currentTarget);if(!$el.hasClass("disabled")){this.pager.setPage(this.pager.page+($el.hasClass("prev")?-1:1));this.updateResults();this.trigger("scrollTo","local-prices")}},nextZIndex:function(){return ++this.zi},storeClick:function(e){var $el=$(e.currentTarget);this.activateOffer($el.data("id"))},activateOffer:function(id){this.$(".store.active").removeClass("active");if(this.activeOfferId&&this.markersById.hasOwnProperty(this.activeOfferId)){this.setMarkerIcon(this.activeOfferId,"fe8575")}this.$("#store_"+id).addClass("active");if(this.markersById.hasOwnProperty(id)){var m=this.markersById[id];this.setMarkerIcon(id,"4f88c5");m.setZIndex(this.nextZIndex())}this.activeOfferId=id},setMarkerIcon:function(id,color){var o=this.model.get("offers").get(id);var markerUrl="https://chart.googleapis.com/chart?chst=d_map_pin_letter&chld="+o.get("letter")+"%7C"+color;this.markersById[id].setIcon(markerUrl);$("#store_"+id).find("img").attr("src",markerUrl)},render:function(){this.zi=this.model.get("offers").size();this.$el.addClass("loaded");if(this.model.hasOffers()){this.$el.removeClass("no_offers");var locPoint=this.model.get("offers").first().get("address").geoPoint;var $productInfo=this.$el.parent().find(".product_info");$productInfo.find(".nearby_prices").html(this.templatePriceButton(this.model.priceInfo()));$productInfo.find(".price_info").addClass("local_enabled");$(".price_buttons.mobile .local_price").replaceWith(this.mustache(this.model.priceButtonMap(),this.templatePriceButtonMobile));this.$el.find(".local_container").html(this.mustache(this.pager.context()));this.mapEl=this.$(".map .canvas").get(0);this.map=new google.maps.Map(this.mapEl,{zoom:10,disableDefaultUI:true,disableDoubleClickZoom:true,draggable:false,scrollwheel:false,center:new google.maps.LatLng(locPoint.latitude,locPoint.longitude),mapTypeId:google.maps.MapTypeId.ROADMAP});google.maps.event.addListener(this.map,"bounds_changed",this.enforceMaxZoom);this.mapOffers(this.pager.context().items)}else{this.$el.addClass("no_offers");this.$el.find(".local_container").html(this.mustache());if(!$(".online_prices_content").length){$("section.fake.subpage.prices").addClass("no_data")}}$(document).trigger("reinitScrollspy")},updateResults:function(){var context=this.pager.context();this.$(".offers").html(this.templateOffers(context));this.$(".paging").html(this.templatePager(context));this.mapOffers(context.items)},enforceMaxZoom:function(){if(this.map.getZoom()>this.MAX_ZOOM){this.map.setZoom(this.MAX_ZOOM)}},mapOffers:function(offers){_.each(this.markers,function(m){m.setMap(null)},this);this.markers.length=0;this.markersById={};this.activeOfferId=null;var _this=this;var marker;var bounds=new google.maps.LatLngBounds();var charcode;_.each(offers,function(o,i){var loc=o.address.geoPoint;var latlng=new google.maps.LatLng(loc.latitude,loc.longitude);bounds.extend(latlng);marker=new google.maps.Marker({position:latlng,map:this.map,icon:"https://chart.googleapis.com/chart?chst=d_map_pin_letter&chld="+o.letter+"%7Cfe8575",zIndex:0});marker.offer=o;google.maps.event.addListener(marker,"click",function(){(function(){var id=o.id;_this.activateOffer(id)}())});this.markers.push(marker);this.markersById[o.id]=marker},this);this.map.fitBounds(bounds)}});ns("decide.views").PriceChart=decide.ApplicationView.extend({ANIMATION_SPEED:1200,initialize:function(){_.bindAll(this);this.$chart=this.$(".price_chart");this.$ranges=this.$(".ranges");Highcharts.setOptions({plotOptions:{series:{animation:{duration:this.ANIMATION_SPEED}}},chart:{style:{fontFamily:"Arial"}}});this.today=new Date();this.today.setHours(0,0,0,0);this.render()},chartColors:{area:"#EAF6F8",stroke:"#48A2B9",label:"#48A2B9",title:"#9D9D9D",subtitle:"#333333",border:"#cccccc"},render:function(){if(this.validatePriceObservations()){var phs=decide.bootstrapData.lowestPriceHistory;var priceData=_(phs.observation).map(function(d){return[new Date(d.date.replace(/[A-Za-z]/i,"")).getTime(),d.price]});var lastData=priceData[priceData.length-1];var lastKnownDate=lastData[0];var formatDateLabel=this.formatDateLabel;var minMax=this.enforceMinVerticalPadding({min:phs.minPrice,max:phs.maxPrice});var min=minMax.min,max=minMax.max;var colors=this.chartColors;var labelStyle={color:colors.label,fontSize:"13px"};var chart=new Highcharts.Chart({chart:{renderTo:this.$(".price_chart").get(0),type:"area",zoomType:"",margin:0,spacingRight:0,spacingBottom:0,spacingLeft:0,spacingTop:0,spacing:0,alignTicks:false,events:{redraw:function(){prevPointDate=null}},style:{fontFamily:"Arial",fontSize:"14px"}},credits:{enabled:false},colors:[colors.stroke,colors.area],xAxis:{type:"datetime",dateTimeLabelFormats:{day:"%b %e"},labels:{align:"right",x:-1,y:-5,step:2,style:labelStyle,formatter:function(){var date=new Date(this.value);if(isNaN(date.getTime())){console.log("couldn't construct a date from "+this.value);return this.value}var retString="";if(date.getTime()>lastKnownDate){}else{retString=formatDateLabel(date);prevPointDate=date}return retString}},gridLineWidth:0,gridLineColor:"#f6f6f6",tickLength:0,endOnTick:false,showLastLabel:true,showFirstLabel:false},yAxis:{endOnTick:false,allowDecimals:false,showFirstLabel:true,showLastLabel:true,title:null,min:min,max:max,labels:{align:"left",x:15,y:-5,style:labelStyle,formatter:function(){return"$"+this.value}},startOnTick:false,step:1,gridLineWidth:0,gridLineColor:"#f6f6f6"},title:{text:null},legend:{enabled:false},plotOptions:{area:{fillOpacity:0.1,shadow:false,lineWidth:3,marker:{enabled:true,radius:5,states:{hover:{enabled:true,radius:5}}}},series:{states:{hover:{lineWidth:3}}}},series:[{data:priceData,marker:{enabled:false}}],tooltip:{shadow:false,borderColor:"#ccc",borderWidth:1,formatter:function(){var date=new Date(this.key);var dateFormatted=formatDateLabel(date);return"<span>"+dateFormatted+"</span><br><strong>$"+this.y+"</strong>"},style:{color:"#666",fontSize:"11px",padding:"4px"}}},this.postRender)}else{console.warn("not enough price history to render the price chart")}return this},postRender:function(chart){chart.sizeConfig=chart.SIZE_OPTIONS.big;chart.initExtremes();chart.setRange(10000);this.chart=chart;this.renderRanges();this.$el.trigger("chartRendered")},renderRanges:function(){var $rangeItems=this.$ranges.find("li");$rangeItems.last().addClass("selected");$rangeItems.off("click","a").on("click","a",_.bind(function(e){var $el=$(e.currentTarget);var $item=$el.parent();var days=$el.data("days");if(!$el.is(".selected")){this.chart.setRange(parseInt(days,10)||10000);$rangeItems.removeClass("selected");$item.addClass("selected")}return false},this))},validatePriceObservations:function(){return(ns("decide.bootstrapData.lowestPriceHistory.observation")||[]).length},formatDateLabel:function(date){return date.forPattern("MMM d yy",false,undefined,true)},minVerticalPaddingPercent:0.14,enforceMinVerticalPadding:function(point){var padding=this.minVerticalPaddingPercent*(point.max-point.min);var min=point.min-padding;var max=point.max+padding;if((max-min)<40){max+=20;min-=20}min=Math.max(min,0);return{min:min,max:max}}});ns("decide.views").ProductPage=decide.ApplicationPage.extend({name:"product",initialize:function(){_.bindAll(this);decide.eventBus.on("route:product:price-prediction",this.routePricePredictionHandler);decide.eventBus.on("route:product",this.routeProduct);this.priceChart=new decide.views.PriceChart({el:$(".rec_box.price")});this.sentiment=new decide.views.Sentiment({el:this.$(".sentiments")});$(".ie8 #compare_page_contents > ol > li:nth-child(1)").addClass("first-child");$(".ie8 #compare_page_contents > ol > li:nth-child(2)").addClass("second-child");this.$window=$(window);this.$nav=$(".product_nav");this.navTop=this.$nav.offset()&&this.$nav.height()?this.$nav.offset().top-this.$nav.height()+42:0;if(!decide.env.isMobile()&&!$("html").is(".ie")){this.$window.on("scroll",this.scroll);$("body").scrollspy({target:".product_nav",offset:10});this.$nav.children("li:first").addClass("active")}},events:{"click .show-base-models":"baseModelsClickHandler","click li.disabled":"disabledClickHandler"},scroll:function(){if(this.$window.scrollTop()>=this.navTop){this.$nav.addClass("fixed")}else{this.$nav.removeClass("fixed")}},routePricePredictionHandler:function(){if(decide.env.isMobile()){console.log("Re-rendering price chart");this.priceChart.render()}},routeProduct:function(){if(decide.env.isMobile()){window.scrollTo(0,0)}},baseModelsClickHandler:function(){$("#base-model-modal").modal("show");return false},disabledClickHandler:function(e){if(e.preventDefault){e.preventDefault()}if(e.stopPropagation){e.stopPropagation()}return false}});ns("decide.views").ProductTile=decide.ApplicationView.extend({initialize:function(){_.bindAll(this)}});ns("decide.views").Sentiment=decide.ApplicationView.extend({initialize:function(){_.bindAll(this);this.setupPagers()},events:{"click .show_positive":"showPositiveSnippets","click .show_negative":"showNegativeSnippets","click .breakdown .hide":"hideSnippets"},setupPagers:function(){this.$(".snippets").each(_.bind(function(i,el){new decide.views.SentimentPager({el:el})},this))},showPositiveSnippets:function(e){return this.showSnippets(e,"positive")},showNegativeSnippets:function(e){return this.showSnippets(e,"negative")},showSnippets:function(e,polarity){e.preventDefault();var $el=$(e.target);if(!$el.hasClass("disabled")){var $sentiment=$el.closest(".sentiment");$sentiment.addClass("show_"+polarity+"_snippets")}},hideSnippets:function(e){var $el=$(e.target);$el.closest(".sentiment").removeClass("show_positive_snippets").removeClass("show_negative_snippets");console.log("hiding snippets");return false}});ns("decide.views").SentimentPager=decide.ApplicationView.extend({itemsPerPage:5,currentPage:1,initialize:function(){_.bindAll(this);this.$snippets=this.$el.find("ul:first");this.page()},events:{"click .pager .previous":"previous","click .pager .next":"next"},previous:function(e){var page=Math.max(1,this.currentPage-1);this.page(page)},next:function(e){page=Math.min(this.maxPage(),this.currentPage+1);this.page(page)},page:function(page){page=page||this.currentPage;var start=this.itemsPerPage*(page-1);var end=start+this.itemsPerPage;console.log("show items between",start,"and",end,"for page",page);this.$snippets.children().hide().slice(start,end).show();this.currentPage=page;this.invalidateButtonsDisabled()},maxPage:function(){return Math.ceil(this.$snippets.children().length/5)},invalidateButtonsDisabled:function(){var $pager=this.$(".pager"),$previous=$pager.find("li:first").removeClass("disabled");$next=$pager.find("li:last").removeClass("disabled"),page=this.currentPage;if(page==1){$previous.addClass("disabled")}if(page==this.maxPage()){$next.addClass("disabled")}}});