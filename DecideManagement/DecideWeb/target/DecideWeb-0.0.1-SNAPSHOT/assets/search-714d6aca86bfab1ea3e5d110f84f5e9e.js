ns("decide.pjax").Search=decide.ApplicationModel.extend({defaults:{offset:0,limit:24},initialize:function(){_.bindAll(this);this.on("change:offset",_.bind(this.fetch,this,{}));this.sync=_.wrap(this.sync,function(f,method,model,options){f(method,model,_.extend(options,{dataType:"jsonp"}))})},url:function(){return document.location.pathname+URI(document.location.search).addQuery({o:this.get("offset")}).href()},next:function(){return this.set({offset:(this.get("offset")+this.get("limit"))})}});ns("decide.views").Window=decide.ApplicationView.extend({SCROLL_DISTANCE_THRESHOLD:800,SCROLL_PERCENT_MINIMUM:0.6,initialize:function(){this.$document=$(document);_.bindAll(this);this.model.bind("sync:complete",this.hideLoader,this);var scrollSectionEl=decide.env.isPositionFixedSupported()?window:$("#search_page_contents");this.scrollSection=new decide.views.ScrollSection({el:scrollSectionEl});this.$infiniteScrollIndicator=$("#loader-infinite-scroll")},events:{scroll:"scroll"},showLoader:function(){this.$infiniteScrollIndicator.show()},hideLoader:function(){if(!$("body").hasClass("fully-loaded")){this.$infiniteScrollIndicator.hide()}},scroll:function(){if(this._shouldInfiniteScroll()){console.log("Trigger infinite scroll");this.model.next();this.showLoader()}this.scrollSection.refresh()},_shouldInfiniteScroll:function(){return $("body").hasClass("search")&&!$("#results").hasClass("hide-from-mobile")&&!$("body").hasClass("fully-loaded")&&this._distanceFromBottom()<this.SCROLL_DISTANCE_THRESHOLD&&this._percentScrolled()>this.SCROLL_PERCENT_MINIMUM&&!this.model.isLoading},_distanceFromBottom:function(){return this.scrollSection._distanceFromBottom()||(this.$document.height()-(this.$el.height()+this.$el.scrollTop()))},_percentScrolled:function(){return this.scrollSection._percentScrolled()||((this.$el.scrollTop())/(this.$document.height()-this.$el.height()))}});ns("decide.views").Facets=decide.ApplicationView.extend({initialize:function(){this.wireHovers()},wireHovers:function(){this.$("div.facet a").hover(function(){$(this).addClass("hover")},function(){$(this).removeClass("hover")});var $decideScoreFacet=this.$("div.facet.decideScoreMessage");var infoTitle="Know what to buy with Decide Score.";var infoContent="Decide Score is our unique product rating system. It incorporates millions of user and expert reviews, recency of reviews, and scores from previous models to bring you the most data-driven, unbiased and useful product recommendations.";$decideScoreFacet.find(".header").append('<span class="icon-info-sign"></span>');$decideScoreFacet.find(".icon-info-sign").popover({title:infoTitle,content:infoContent,trigger:"hover"})}});ns("decide.views").SearchControls=decide.ApplicationView.extend({initialize:function(){_.bindAll(this);this.$("#sort .dropdown-menu a").each(function(i,el){var $el=$(el);$el.attr("href",URI(document.location).removeQuery("s").addQuery({s:$el.data("sort")}).href())})}});ns("decide.views").ProductTile=decide.ApplicationView.extend({initialize:function(){_.bindAll(this)}});ns("decide.views").BaseModels=decide.ApplicationView.extend({initialize:function(){_.bindAll(this);this.setTmpl("baseModels");this.$html=$("html");decide.eventBus.on("route",this.closeModal)},events:{"shown div.modal":"shownCallback","hidden div.modal":"hiddenCallback","click a":"closeModal"},shownCallback:function(){this.$html.css("overflow","hidden")},hiddenCallback:function(){this.$html.css("overflow","auto");$(".modal-backdrop").first().remove()},syncStart:function(){$("body").addClass("loading page-loading")},syncSuccess:function(){$("body").removeClass("loading page-loading")},show:function(){this.$("#base-model-modal").modal({fade:true});return this},closeModal:function(){this.$el.find("div.modal").modal("hide")},render:function(){var data=this.ellipsizeBaseModels(this.model.toJSON());this.$el.html(this.mustache(data));return this},ellipsizeBaseModels:function(data){data.productData.baseModelData.models=_.map(data.productData.baseModelData.models,function(model){var ellipsizedTitleAndTopFeatures=decide.helpers.multiStringEllipsis([model.title,model.topFeatures[0]],110);model.title=ellipsizedTitleAndTopFeatures[0];model.topFeatures[0]=ellipsizedTitleAndTopFeatures[1];return model});return data}});ns("decide.views").BaseModelControl=decide.ApplicationView.extend({initialize:function(){_.bindAll(this);this.label=this.$(".show-base-models").data("label");this.baseModels=new decide.views.BaseModels({el:this.$(".base_models"),model:this.model});this.triggerEvent("shown")},events:{"click .show-base-models":"showBaseModels"},showBaseModels:function(e){var pd=this.model.get("productData");if(pd&&pd.baseModelData){this.triggerEvent("clicked");this.baseModels.render().show()}else{this.model.fetch({success:this.showBaseModels})}e&&e.preventDefault&&e.preventDefault()},triggerEvent:function(action){var urlRegex=/\/p\/.*?([0-9]+)$/,matches=urlRegex.exec(window.location.pathname),pageProductId=parseInt(matches&&matches[1]);if(this.label&&decide.pageInfo.find("view")==="product"&&this.model&&this.model.get("id")===pageProductId){decide.eventBus.trigger("variants-link-prod",this.generateEvent(action))}else{if(this.label&&decide.pageInfo.find("view")==="search"&&action==="clicked"){decide.eventBus.trigger("variants-link-search",this.generateEvent(action))}}},generateEvent:function(action){return{action:action,label:this.label}}});ns("decide.views").Search=decide.ApplicationView.extend({initialize:function(){_.bindAll(this);if(this.$el.data("results")==0){$("body").addClass("no_results_found")}this.model=new decide.pjax.Search();this.model.on("sync:complete",this.wireTooltips);this.addViews({window:new decide.views.Window({el:window,model:this.model}),facets:new decide.views.Facets({el:this.$("#facets")}),controls:new decide.views.SearchControls({el:this.$("#controls")})});decide.eventBus.on("signup:success login:success logout",this.accountChangeCallback);decide.eventBus.trigger("banner:shown",{banner:!!$("body").data("email")?"gyb":"upgrade"});this.addProductTileViews();this.wireTooltips()},wireTooltips:function(){this.$(".prediction .icon").tooltip()},accountChangeCallback:function(){if(decide.pageInfo.find("view")===this.name){this.triggerBannerShown()}this.$("#search").toggleClass("locked",!decide.membershipFeatures.paid)},addProductTileViews:function(){this.$(".product_tile").each(function(i,el){new decide.views.ProductTile({el:$(el)})})}});